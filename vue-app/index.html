<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emmy VASSE - Soins naturels pour vos animaux</title>
    <link rel="manifest" href="manifest.json">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="images/logo_emmy.png">
    <link rel="apple-touch-icon" href="images/logo_emmy.png">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css?v=9.3">
    
    <!-- OneSignal -->
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" defer></script>
    <script>
        window.OneSignal = window.OneSignal || [];
        // On n'initialise pas OneSignal immédiatement, on attend la vérification du statut admin
    </script>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Firebase Functions -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    <!-- Firebase Storage -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body>
    <div id="app">
        <header class="header">
            <nav class="nav-container">
                <a href="#" class="logo" @click.prevent="navigateTo('home')">
                    <img src="images/logo_emmy.png" alt="Logo Emmy" style="height: 50px; margin-right: 10px;">
                    Emmy Vasse
                </a>
                <div class="hamburger" @click="toggleMenu" :class="{ active: isMenuOpen }">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                <div class="nav-links" :class="{ active: isMenuOpen, 'tutorial-padding': showTutorial && isMobile }">
                    <div class="close-menu-btn" @click="closeMenu" v-if="isMenuOpen">
                        <span>&times;</span>
                    </div>
                    
                    <!-- Navigation principale -->
                    <div class="nav-section">
                        <a href="#" @click.prevent="navigateToSection('services'); closeMenu()">Outils thérapeutiques</a>
                        <a href="#" @click.prevent="navigateToSection('about'); closeMenu()">À propos</a>
                        <a href="#" @click.prevent="navigateToSection('blog'); closeMenu()">Blog</a>
                        <a href="#" @click.prevent="navigateToSection('contact'); closeMenu()">Contact</a>
                    </div>
                    
                    <!-- Actions utilisateur -->
                    <template v-if="isAuthenticated">
                        <div class="nav-separator"></div>
                        <div class="nav-section user-actions">
                            <a href="#" @click.prevent="navigateTo('appointment'); closeMenu()">Prendre RDV</a>
                            <a href="#" @click.prevent="navigateTo('dossier'); closeMenu()">Dossier Animaux</a>
                            <a href="#" @click.prevent="navigateTo('profile'); closeMenu()">Mon Profil</a>
                            <a href="#" @click="navigateTo('admin')" v-if="isAdmin">Administration</a>
                        </div>
                        <div class="nav-separator"></div>
                        <div class="nav-section">
                            <a href="#" @click.prevent="logout(); closeMenu()" class="nav-logout">Déconnexion</a>
                        </div>
                    </template>
                    <template v-if="!isAuthenticated">
                        <div class="nav-separator"></div>
                        <div class="nav-section">
                            <a href="#" @click.prevent="showAuth = true; closeMenu()" class="nav-login">Connexion</a>
                        </div>
                    </template>
                </div>
            </nav>
        </header>

        <div class="page-container">
            <!-- Page d'accueil -->
            <template v-if="currentPage === 'home'">
                <section class="hero">
                    <div class="hero-content">
                        <h1>Soins naturels pour vos animaux</h1>
                        <p>Thérapeute manuelle animalier, je vous propose des soins adaptés à chaque espèce pour améliorer leur bien-être et leur qualité de vie.</p>
                        <a href="#" @click.prevent="navigateTo('appointment')" class="btn" v-if="isAuthenticated">Prendre rendez-vous</a>
                        <a href="#" class="btn" v-else @click.prevent="showAuth = true">Se connecter pour prendre RDV</a>
                    </div>
                </section>

                <section id="services" class="section services">
                    <h2 class="section-title">Mes Outils Thérapeutiques</h2>
                    <div class="services-grid">
                        <div class="service-card">
                            <h3>Rééquilibrage corporel</h3>
                            <p>Permet de retrouver équilibre et harmonie dans l'ensemble des sphères du corps (articulaire, musculaire, viscérale, crânienne)</p>
                        </div>
                        <div class="service-card">
                            <h3>Soin émotionnel</h3>
                            <p>Libération d'émotions cristalisés dans les tissus pouvant être la cause de trouble psycologique et physique.</p>
                        </div>
                        <div class="service-card">
                            <h3>Soin énergétique</h3>
                            <p>Rééquilibrage des énergies afin de favoriser le bien-être physique, émotionnel et mental de l'animal.</p>
                        </div>
                        <div class="service-card">
                            <h3>Naturopathie</h3>
                            <p>Traitement naturel par les plantes : fleurs de Bach, aromathérapie, phytothérapie, homéopathie.</p>
                        </div>
                        <div class="service-card">
                            <h3>Massage et étirement</h3>
                            <p>Permet une détente musculaire et un apaisement global. Permet à l'animal de récupérer une élasticité musculaire optimal.</p>
                        </div>
                        <div class="service-card">
                            <h3>Nutrition</h3>
                            <p>Analyse et personnalisation des rations proposées à l'animal en fonction de ses besoins et spécificité.</p>
                        </div>
                    </div>
                </section>

                <section id="about" class="section">
                    <h2 class="section-title">À Propos</h2>
                    <div class="about">
                        <div>
                            <h3>Je suis Emmy VASSE,</h3>
                            <p><strong>Thérapeute manuelle animalier</strong>, spécialisée dans une approche globale du bien-être animal.</p>

                            <p>Formée pendant cinq ans en <strong>ostéopathie animale</strong> au CNESOA, j'ai acquis de nombreuses techniques de soin (structurelles, crâniennes, tissulaires…). Mon parcours m'a permis de travailler avec une grande diversité d'animaux : chiens, chats, chevaux, ruminants, NAC...</p>

                            <p>Je me suis ensuite formée en <strong>éducation canine (MEC1)</strong>, en <strong>naturopathie animalière</strong> (nutrition, homéopathie, fleurs de Bach, etc.) et en <strong>magnétisme</strong>, afin d'intégrer une dimension <strong>énergétique et émotionnelle</strong> à ma pratique.</p>

                            <p>Aujourd'hui, j'interviens à domicile dans l'<strong>Ain</strong> et le <strong>Jura</strong>, ainsi qu'au <strong>club canin Jura Sud (ACJS)</strong> à Jeurre, où je propose également des cours d'éducation.</p>
                        </div>
                        <img src="\images\Emmy_pratique.jpg" alt="Emmy pratique sur un chien" class="about-image">
                    </div>
                </section>

                <section id="blog" class="blog-section">
                    <div class="blog-container">
                        <div class="blog-header">
                            <h2 class="section-title">Actualités & Événements</h2>
                            <div v-if="isAdmin" class="admin-controls">
                                <button class="btn" @click="showAddPostModal = true">
                                    Ajouter un article
                                </button>
                            </div>
                        </div>
                        <div class="blog-grid">
                            <article v-for="post in blogPosts" :key="post.id" class="blog-post" @click="showPostDetails(post)">
                                <img :src="post.imageUrl" :alt="post.title" class="blog-post-image">
                                <div class="blog-post-content">
                                    <div class="blog-post-date">{{ formatDate(post.date) }}</div>
                                    <h3 class="blog-post-title">{{ post.title }}</h3>
                                    <p class="blog-post-excerpt">{{ post.excerpt }}</p>
                                    <div class="blog-post-link">
                                        Lire la suite
                                    </div>
                                </div>
                            </article>
                        </div>
                    </div>
                </section>

                <section id="contact" class="section contact">
                    <div class="contact-grid" style="background:none; box-shadow:none; border:none;">
                        <div class="contact-form-container">
                            <div class="contact-title" style="text-align:left;">Avez-vous des questions? <br>Contactez-moi!</div>
                            <form @submit.prevent="sendMessage">
                                <div class="form-group">
                                    <label for="name">Nom</label>
                                    <input type="text" id="name" v-model="contactForm.name" required>
                                </div>
                                <div class="form-group">
                                    <label for="email">Email</label>
                                    <input type="email" id="email" v-model="contactForm.email" required>
                                </div>
                                <div class="form-group">
                                    <label for="message">Message</label>
                                    <textarea id="message" v-model="contactForm.message" rows="5" required></textarea>
                                </div>
                                <button type="submit" class="btn">Envoyer</button>
                            </form>
                        </div>
                        <div class="contact-info-container">
                            <p style="margin-bottom: 0.7rem;">Pour toute demande, contactez-moi par téléphone, mail ou via les réseaux sociaux.<br>Je vous répondrai dans les plus brefs délais.</p>
                            <div class="contact-info-block" style="background: #f8fafc; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); padding: 1.2rem 1.5rem; margin-bottom: 1.2rem;">
                                <div style="display: flex; align-items: center; gap: 0.7rem; margin-bottom: 0.5rem;">
                                    <img src="images/location.svg" alt="Adresse" style="width: 22px; height: 22px; opacity: 0.7;">
                                    <a href="https://www.google.com/maps/place//data=!4m2!3m1!1s0x6c2f3832ff1c07a1:0xc10ae36728d79394?sa=X&ved=1t:8290&hl=fr&ictx=111" target="_blank" style="color: var(--primary-color); text-decoration: none; font-weight: 500;">61 Grande Rue, 39240 Thoirette-Coisia</a>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.7rem; margin-bottom: 0.5rem;">
                                    <img src="images/phone.svg" alt="Téléphone" style="width: 22px; height: 22px; opacity: 0.7;">
                                    <a href="tel:0651082126" style="color: var(--primary-color); text-decoration: none; font-weight: 500;">06 51 08 21 26</a>
                                </div>
                                <div style="display: flex; align-items: center; gap: 0.7rem; margin-bottom: 0.5rem;">
                                    <img src="images/mail.svg" alt="Mail" style="width: 22px; height: 22px; opacity: 0.7;">
                                    <a href="mailto:mystereandemmy@gmail.com" style="color: var(--primary-color); text-decoration: none; font-weight: 500; overflow-wrap: anywhere; word-break: break-all;">mystereandemmy@gmail.com</a>
                                </div>
                            </div>
                            <div class="contact-socials" style="display: flex; gap: 1.2rem; align-items: center; margin-top: 0.5rem;">
                                <a href="https://www.facebook.com/people/Th%C3%A9rapeute-Manuelle-Animalier-Emmy-Vasse/61555277590644/" target="_blank" aria-label="Facebook" style="display: flex; align-items: center; gap: 0.5rem; color: #1877f3; font-weight: 600; text-decoration: none; font-size: 1.1rem;">
                                    <img src="images/facebook.svg" alt="Facebook" style="width: 28px; height: 28px;"> Facebook
                                </a>
                            </div>
                        </div>
                    </div>
                </section>
            </template>

            <!-- Page de rendez-vous -->
            <template v-if="currentPage === 'appointment'">
                <section class="appointment-page">
                    <div class="appointment-header">
                        <h1>Prendre un rendez-vous</h1>
                        <p>Choisissez une date et une heure qui vous conviennent pour votre consultation</p>
                    </div>

                    <div class="appointment-steps">
                        <div class="step">
                            <div class="step-number">1</div>
                            <h3>Choisissez votre animal</h3>
                            <p>Sélectionnez un animal existant dans votre dossier ou créez un nouveau profil en renseignant ses informations</p>
                        </div>
                        <div class="step">
                            <div class="step-number">2</div>
                            <h3>Sélectionnez la date et l'heure</h3>
                            <p>Choisissez une date parmi celles disponibles, puis sélectionnez le créneau horaire qui vous convient</p>
                        </div>
                        <div class="step">
                            <div class="step-number">3</div>
                            <h3>Confirmez votre rendez-vous</h3>
                            <p>Votre rendez-vous est immédiatement enregistré et ajouté à l'historique de votre animal</p>
                        </div>
                    </div>

                    <div class="appointment-form">
                        <div v-if="appointmentSuccess" class="success-message" style="background: var(--light-bg); color: var(--text-color); padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem;">
                            <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Demande de rendez-vous enregistrée</h3>
                            <p style="margin-bottom: 0.8rem;">Votre demande de rendez-vous a bien été prise en compte. Cependant, elle doit encore être validée.</p>
                            <p style="margin-bottom: 0.8rem;">Vous recevrez prochainement une confirmation par SMS ou par email. Le rendez-vous ne sera définitif qu'après cette confirmation de notre part.</p>
                            <p>En cas de question, n'hésitez pas à nous contacter directement.</p>
                        </div>
                        <div v-if="appointmentError" class="error-message">
                            {{ appointmentError }}
                        </div>
                        <form @submit.prevent="submitAppointment">
                            <div class="form-group">
                                <label for="consultationType">Type de consultation</label>
                                <select id="consultationType" v-model="appointmentForm.consultationType" required>
                                    <option value="">Sélectionnez le type de consultation</option>
                                    <option value="premiere">Première consultation</option>
                                    <option value="suivi">Consultation de suivi</option>
                                    <option value="particulier">Consultation pour motif particulier</option>
                                </select>
                            </div>

                            <!-- Message pour première consultation ou motif particulier -->
                            <div v-if="appointmentForm.consultationType === 'premiere' || appointmentForm.consultationType === 'particulier'" class="info-message" style="background: var(--light-bg); padding: 1.5rem; border-radius: 10px; margin: 1rem 0;">
                                <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Prise de contact nécessaire</h3>
                                <p style="margin-bottom: 1rem;">Pour ce type de consultation, merci de me contacter directement via :</p>
                                <ul style="list-style: none; margin-bottom: 1rem;">
                                    <li style="margin-bottom: 0.5rem;">📞 Téléphone : <a href="tel:0612345678">06 12 34 56 78</a></li>
                                    <li style="margin-bottom: 0.5rem;">📱 Réseaux sociaux : 
                                        <a href="#" style="margin-right: 0.5rem;">Instagram</a>
                                        <a href="#">Facebook</a>
                                    </li>
                                </ul>
                                <p>Ou utilisez le <a href="#contact" @click="scrollToContact">formulaire de contact</a> ci-dessous.</p>
                            </div>

                            <!-- Formulaire pour consultation de suivi -->
                            <template v-if="appointmentForm.consultationType === 'suivi'">
                            <div class="form-group">
                                    <label for="animalSelect">Sélectionner un animal</label>
                                    <select id="animalSelect" v-model="appointmentForm.selectedAnimalId" @change="onAnimalSelected" required>
                                        <option value="">Sélectionnez un animal</option>
                                        <option v-for="animal in animals" :key="animal.id" :value="animal.id">
                                            {{ animal.name }} ({{ animal.species }})
                                        </option>
                                        <option value="autre">Autre animal</option>
                                </select>
                            </div>

                                <!-- Message pour "Autre animal" -->
                                <div v-if="appointmentForm.selectedAnimalId === 'autre'" class="info-message" style="background: var(--light-bg); padding: 1.5rem; border-radius: 10px; margin: 1rem 0;">
                                    <h3 style="color: var(--primary-color); margin-bottom: 1rem;">Nouvel animal</h3>
                                    <p style="margin-bottom: 1rem;">Pour un nouvel animal, merci de me contacter directement via :</p>
                                    <ul style="list-style: none; margin-bottom: 1rem;">
                                        <li style="margin-bottom: 0.5rem;">📞 Téléphone : <a href="tel:0612345678">06 12 34 56 78</a></li>
                                        <li style="margin-bottom: 0.5rem;">📱 Réseaux sociaux : 
                                            <a href="#" style="margin-right: 0.5rem;">Instagram</a>
                                            <a href="#">Facebook</a>
                                        </li>
                                    </ul>
                                    <p>Ou utilisez le <a href="#contact" @click="scrollToContact">formulaire de contact</a> ci-dessous.</p>
                            </div>

                                <!-- Formulaire de rendez-vous pour un animal existant -->
                                <template v-if="appointmentForm.selectedAnimalId && appointmentForm.selectedAnimalId !== 'autre'">
                            <div class="form-group">
                                <label for="phone">Numéro de téléphone</label>
                                <input type="tel" id="phone" v-model="appointmentForm.phone" 
                                       pattern="[0-9]{10}" 
                                       placeholder="0612345678" 
                                       required>
                                <small style="color: var(--text-color); font-size: 0.8rem;">Format: 10 chiffres (ex: 0612345678)</small>
                            </div>

                            <div class="form-group">
                                <label for="appointmentDate">Date du rendez-vous</label>
                                <select id="appointmentDate" 
                                        v-model="appointmentForm.date" 
                                        required
                                        :disabled="isLoadingDates">
                                    <option value="">Sélectionnez une date</option>
                                    <option v-for="date in availableDates" 
                                            :key="date" 
                                            :value="date">
                                        {{ formatDateFr(date) }}
                                    </option>
                                </select>
                                <div v-if="isLoadingDates" class="loading-message">
                                    Chargement des dates disponibles...
                                </div>
                                <div v-if="!isLoadingDates && availableDates.length === 0" class="no-slots-message" style="color: var(--text-color);">
                                    Aucune date disponible pour les 30 prochains jours.
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Heure du rendez-vous</label>
                                <div v-if="displayedTimeSlots.length === 0" class="no-slots-message">
                                    Aucun créneau disponible pour cette date.
                                </div>
                                <div v-else class="time-slots">
                                    <button v-for="slot in displayedTimeSlots" 
                                         :key="slot"
                                         type="button"
                                         class="time-slot"
                                         :class="{ 'selected': appointmentForm.time === slot }"
                                         @click="appointmentForm.time = slot">
                                        {{ slot }}
                                    </button>
                                    </div>
                                <div class="info-message" style="margin-top: 1rem; color: var(--text-color); font-style: italic; background: var(--light-bg); padding: 1rem; border-radius: 8px;">
                                    D'autres créneaux peuvent être disponibles. N'hésitez pas à me contacter directement :
                                    <ul style="list-style: none; margin-top: 0.5rem;">
                                        <li style="margin-bottom: 0.3rem;">📞 Par téléphone : <a href="tel:0612345678">06 12 34 56 78</a></li>
                                        <li>💬 Par message : <a href="#contact" @click="scrollToContact">formulaire de contact</a></li>
                                    </ul>
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="notes">Notes supplémentaires</label>
                                <textarea id="notes" v-model="appointmentForm.notes" rows="3"></textarea>
                            </div>

                            <button type="submit" class="btn primary">Confirmer le rendez-vous</button>
                                </template>
                            </template>
                        </form>
                    </div>
                </section>
            </template>

            <!-- Page de dossier ostéopathique -->
            <template v-if="currentPage === 'dossier'">
                <section class="dossier-page">
                    <div class="dossier-header">
                        <h1>Dossier Ostéopathique</h1>
                        <p>Consultez les dossiers de vos animaux</p>
                    </div>

                    <div class="dossier-content">
                        <div v-if="!animals.length" class="no-animals">
                            <p>Vous n'avez pas encore d'animaux enregistrés.</p>
                            <p>Contactez votre ostéopathe pour créer un dossier.</p>
                        </div>

                        <div v-else class="animals-list">
                            <div v-for="animal in animals" :key="animal.id" class="animal-card">
                                <div class="animal-info">
                                    <div v-if="animal.photos && animal.photos.length > 0" class="animal-photos-container">
                                        <img :src="animal.photos[0]" :alt="animal.name" class="animal-photo">
                                        <div v-if="animal.photos.length > 1" class="photo-count-badge">
                                            +{{ animal.photos.length - 1 }}
                                        </div>
                                    </div>
                                    <div v-else-if="animal.photoBase64" class="animal-photo-container">
                                        <img :src="animal.photoBase64" :alt="animal.name" class="animal-photo">
                                    </div>
                                    <div v-else class="animal-photo placeholder">
                                        <span>Pas de photo</span>
                                    </div>
                                    <h3>{{ animal.name }}</h3>
                                    <p class="animal-birthdate">Né le: {{ formatDate(animal.birthdate) }}</p>
                                </div>
                                <div class="animal-actions">
                                    <button v-if="animal.documents && animal.documents.length > 0" 
                                            class="btn primary" 
                                            @click="viewAnimalDocuments(animal)">
                                        Voir les documents ({{ animal.documents.length }})
                            </button>
                        </div>
                    </div>
                        </div>
                    </div>
                </section>
            </template>

            <!-- Page d'administration -->
            <template v-if="currentPage === 'admin' && isAdmin">
                <section class="admin-page">
                    <div class="admin-header">
                        <h1 class="section-title">Interface Administrateur</h1>
                        <p>Gestion des dossiers animaux et des rendez-vous</p>
                    </div>

                    <div class="admin-tabs">
                                                    <button 
                                :class="['admin-tab', { active: adminActiveTab === 'animals' }]"
                                @click="switchAdminTab('animals')">
                                Dossiers Animaux
                            </button>
                            <button 
                                :class="['admin-tab', { active: adminActiveTab === 'appointments' }]"
                                @click="switchAdminTab('appointments')">
                                Rendez-vous
                            </button>
                            <button 
                                :class="['admin-tab', { active: adminActiveTab === 'slots' }]"
                                @click="switchToSlotsTab">
                                Créneaux
                            </button>
                            <button 
                                :class="['admin-tab', { active: adminActiveTab === 'clients' }]"
                                @click="switchAdminTab('clients')">
                                Clients
                            </button>
                            <button 
                                :class="['admin-tab', { active: adminActiveTab === 'messages' }]"
                                @click="switchAdminTab('messages')">
                                Messages
                                <span v-if="unreadMessagesCount > 0" class="notification-badge">{{ unreadMessagesCount }}</span>
                            </button>
                    </div>

                    <!-- Onglet Dossiers Animaux -->
                    <div v-if="adminActiveTab === 'animals'" class="admin-content">
                        <div class="admin-header-actions">
                        <div class="search-bar">
                            <input 
                                type="text" 
                                v-model="animalsSearch" 
                                placeholder="Rechercher un animal...">
                            </div>
                            <button class="btn primary" @click="showAddAnimalModal = true">
                                Ajouter un animal
                            </button>
                        </div>

                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Type</th>
                                    <th>Propriétaire</th>
                                    <th>Date de naissance</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="animal in filteredAnimals" :key="animal.id">
                                    <td>{{ animal.name }}</td>
                                    <td>{{ animal.species }}</td>
                                    <td>{{ getUserFullName(animal.userId) }}</td>
                                    <td>{{ formatDate(animal.birthdate) }}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-view" @click="viewAnimalDetails(animal)">
                                                Voir
                                            </button>
                                            <button class="btn-edit" @click="editAnimal(animal)">
                                                Modifier
                                            </button>
                                            <button class="btn-delete" @click="deleteAnimal(animal)">
                                                Supprimer
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr v-if="filteredAnimals.length === 0">
                                    <td colspan="5" class="text-center">Aucun animal trouvé</td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Modal d'ajout d'animal -->
                        <div v-if="showAddAnimalModal" class="modal">
                            <div class="modal-content">
                                <h2>Ajouter un animal</h2>
                                <form @submit.prevent="addAnimal">
                                    <div class="form-group">
                                        <label for="animalOwner">Propriétaire</label>
                                        <select id="animalOwner" v-model="newAnimal.userId" required>
                                            <option value="">Sélectionnez un client</option>
                                            <option v-for="client in allClients" :key="client.id" :value="client.id">
                                                {{ client.firstName }} {{ client.lastName }} ({{ client.email }})
                                            </option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="newAnimalName">Nom de l'animal</label>
                                        <input type="text" id="newAnimalName" v-model="newAnimal.name" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="newAnimalSpecies">Espèce</label>
                                        <select id="newAnimalSpecies" v-model="newAnimal.species" required>
                                            <option value="">Sélectionnez une espèce</option>
                                            <option value="chien">Chien</option>
                                            <option value="chat">Chat</option>
                                            <option value="cheval">Cheval</option>
                                            <option value="autre">Autre</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="newAnimalRace">Race</label>
                                        <input type="text" id="newAnimalRace" v-model="newAnimal.race">
                                    </div>
                                    <div class="form-group">
                                        <label for="newAnimalBirthdate">Date de naissance</label>
                                        <input type="date" id="newAnimalBirthdate" v-model="newAnimal.birthdate" required>
                                    </div>
                                    <div class="form-group" style="display: flex; align-items: center; gap: 1rem;">
                                        <label style="margin-bottom: 0;">Stérilisation :</label>
                                        <div class="radio-group" style="display: flex; gap: 1.5rem;">
                                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="radio" v-model="newAnimal.sterilization" :value="true">
                                                Oui
                                            </label>
                                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="radio" v-model="newAnimal.sterilization" :value="false">
                                                Non
                                            </label>
                                        </div>
                                    </div>
                                    <div class="form-group" v-if="newAnimal.sterilization">
                                        <label for="newAnimalSterilizationDetails">Détails de la stérilisation</label>
                                        <textarea id="newAnimalSterilizationDetails" v-model="newAnimal.sterilizationDetails" rows="2"
                                                placeholder="Date de stérilisation, type d'intervention, vétérinaire, etc."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="newAnimalDiet">Alimentation</label>
                                        <textarea id="newAnimalDiet" v-model="newAnimal.diet" rows="2" 
                                                placeholder="Type d'alimentation, fréquence des repas, etc."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="newAnimalActivity">Activité</label>
                                        <select id="newAnimalActivity" v-model="newAnimal.activity" required>
                                            <option value="">Sélectionnez le niveau d'activité</option>
                                            <option value="sédentaire">Sédentaire (très peu d'activité)</option>
                                            <option value="peu_actif">Peu actif (activité occasionnelle)</option>
                                            <option value="actif">Actif (activité régulière)</option>
                                            <option value="très_actif">Très actif (activité intense et fréquente)</option>
                                            <option value="sportif">Sportif/Compétition</option>
                                        </select>
                                        <textarea id="newAnimalActivityDetails" v-model="newAnimal.activityDetails" rows="2"
                                                placeholder="Détails sur le type d'activité (promenades, sport, etc.)"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="newAnimalMedicalHistory">Antécédents médicaux</label>
                                        <textarea id="newAnimalMedicalHistory" v-model="newAnimal.medicalHistory" rows="3"
                                                placeholder="Maladies, opérations, blessures passées, etc."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="newAnimalTreatment">Traitement en cours</label>
                                        <textarea id="newAnimalTreatment" v-model="newAnimal.treatment" rows="2"
                                                placeholder="Médicaments, posologie, durée, etc."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="newAnimalTravelTime">Temps de trajet</label>
                                        <input type="text" id="newAnimalTravelTime" v-model="newAnimal.travelTime"
                                               placeholder="Ex: 30 minutes">
                                    </div>
                                    <div class="form-group">
                                        <label for="newAnimalBehavior">Particularités comportementales</label>
                                        <textarea id="newAnimalBehavior" v-model="newAnimal.behavior" rows="2"
                                                placeholder="Comportements particuliers, anxiété, agressivité, etc."></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="newAnimalNotes">Notes supplémentaires</label>
                                        <textarea id="newAnimalNotes" v-model="newAnimal.notes" rows="3"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="newAnimalPhotos">Photos de l'animal</label>
                                        <input type="file" id="newAnimalPhotos" accept="image/*" multiple @change="handlePhotosUpload">
                                        <small style="color: var(--text-color); font-size: 0.8rem;">Format recommandé : JPG, PNG (max 5MB par image, max 10 images)</small>
                                        <div v-if="newAnimal.photosPreview && newAnimal.photosPreview.length > 0" class="photos-preview">
                                            <div v-for="(preview, index) in newAnimal.photosPreview" :key="index" class="photo-item">
                                                <img :src="preview" alt="Aperçu de la photo" style="max-width: 150px; max-height: 150px; object-fit: cover; margin: 0.5rem;">
                                                <button type="button" @click="removePhoto(index)" class="btn-remove-photo">×</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="newAnimalDocuments">Documents</label>
                                        <input type="file" id="newAnimalDocuments" @change="handleDocumentUpload">
                                        <small style="color: var(--text-color); font-size: 0.8rem;">Formats acceptés : PDF, JPG, PNG (max 10MB)</small>
                                    </div>
                                    <div class="modal-actions">
                                        <button type="button" class="btn secondary" @click="showAddAnimalModal = false">Annuler</button>
                                        <button type="submit" class="btn primary">Enregistrer</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Onglet Rendez-vous -->
                    <div v-if="adminActiveTab === 'appointments'" class="admin-content">
                        <div class="admin-header-actions">
                            <div class="search-bar">
                                <input 
                                    type="text" 
                                    v-model="appointmentsSearch" 
                                    placeholder="Rechercher un rendez-vous...">
                            </div>
                            <button class="btn primary" @click="showAdminNewAppointmentModal = true">
                                Nouveau rendez-vous
                            </button>

                            <div class="view-toggle">
                                <button 
                                    :class="['btn', appointmentsView === 'list' ? 'primary' : 'secondary']"
                                    @click="appointmentsView = 'list'">
                                    Vue Liste
                                </button>
                                <button 
                                    :class="['btn', appointmentsView === 'calendar' ? 'primary' : 'secondary']"
                                    @click="appointmentsView = 'calendar'">
                                    Vue Calendrier
                                </button>
                            </div>
                        </div>

                        <!-- Vue Liste -->
                        <div v-if="appointmentsView === 'list'" class="appointments-list-view">
                        <table class="data-table">
                            <thead>
                                <tr>
                                        <th class="sortable" @click="sortAppointments('date')">
                                            Date
                                            <span class="sort-icon" v-if="sortField === 'date'">
                                                {{ sortOrder === 'asc' ? '↑' : '↓' }}
                                            </span>
                                        </th>
                                    <th>Heure</th>
                                    <th>Animal</th>
                                    <th>Client</th>
                                    <th>Téléphone</th>
                                        <th>Adresse</th>
                                        <th>Temps de trajet</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                    <tr v-for="appointment in sortedAppointments" :key="appointment.id">
                                    <td>{{ formatDate(appointment.date) }}</td>
                                    <td>{{ appointment.time }}</td>
                                    <td>{{ appointment.animalName }}</td>
                                    <td>{{ getUserFullName(appointment.userId) }}</td>
                                    <td>{{ appointment.phone }}</td>
                                        <td>{{ userEmails[appointment.userId]?.address || 'Non renseignée' }}</td>
                                        <td>{{ appointment.travelTime || 'Non renseigné' }}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-edit" @click="editAppointment(appointment)">
                                                Modifier
                                            </button>
                                            <button class="btn-delete" @click="deleteAppointment(appointment)">
                                                Supprimer
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr v-if="sortedAppointments.length === 0">
                                    <td colspan="8" class="text-center">Aucun rendez-vous trouvé</td>
                                </tr>
                            </tbody>
                        </table>
                        </div>

                        <!-- Vue Calendrier -->
                        <div v-else class="appointments-calendar-view">
                            <div class="calendar-header">
                                <button class="btn secondary" @click="previousMonth">
                                    <
                                </button>
                                <h3>{{ currentMonthName }} {{ currentYear }}</h3>
                                <button class="btn secondary" @click="nextMonth">
                                    >
                                </button>
                            </div>

                            <div class="calendar-grid">
                                <div class="calendar-weekday" v-for="day in weekDays" :key="day">
                                    {{ day }}
                                </div>
                                <div v-for="day in calendarDays" 
                                     :key="day.date"
                                     class="calendar-day"
                                     :class="{ 
                                         'today': isToday(day.date),
                                         'other-month': !isCurrentMonth(day.date),
                                         'has-appointments': hasAppointments(day.date)
                                     }"
                                     @click="selectDate(day.date)">
                                    {{ day.day }}
                                    <div v-if="hasAppointments(day.date)" class="appointments-indicator">
                                        {{ getAppointmentsCount(day.date) }} RDV
                                    </div>
                                </div>
                            </div>

                            <!-- Liste des rendez-vous pour la date sélectionnée -->
                            <div v-if="selectedDate && getDayAppointments(selectedDate).length > 0" class="day-appointments">
                                <h3>Rendez-vous du {{ formatDate(selectedDate) }}</h3>
                                <div class="appointments-cards">
                                    <div v-for="appointment in getDayAppointments(selectedDate)" 
                                         :key="appointment.id"
                                         class="appointment-card">
                                        <div class="appointment-time">{{ appointment.time }}</div>
                                        <div class="appointment-details">
                                            <div class="appointment-animal">{{ appointment.animalName }}</div>
                                            <div class="appointment-client">{{ getUserFullName(appointment.userId) }}</div>
                                            <div class="appointment-contact">
                                                <div>📞 {{ appointment.phone }}</div>
                                                <div>🚗 {{ appointment.travelTime || 'Non renseigné' }}</div>
                                            </div>
                                        </div>
                                        <div class="appointment-actions">
                                            <button class="btn-edit" @click="editAppointment(appointment)">
                                                Modifier
                                            </button>
                                            <button class="btn-delete" @click="deleteAppointment(appointment)">
                                                Supprimer
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Modal de nouveau rendez-vous admin -->
                        <div v-if="showAdminNewAppointmentModal" class="modal">
                            <div class="modal-content appointment-form-modal">
                                <h2>Nouveau rendez-vous</h2>
                                <form @submit.prevent="submitAdminAppointment">
                                    <div class="form-group">
                                        <label for="adminAppointmentClient">Client</label>
                                        <select 
                                            id="adminAppointmentClient" 
                                            v-model="adminAppointmentForm.userId"
                                            required
                                            @change="loadClientAnimals">
                                            <option value="">Sélectionnez un client</option>
                                            <option v-for="client in allClients" 
                                                    :key="client.id" 
                                                    :value="client.id">
                                                {{ client.firstName }} {{ client.lastName }} ({{ client.email }})
                                            </option>
                                        </select>
                                    </div>

                                    <div v-if="adminAppointmentForm.userId" class="form-group">
                                        <label for="adminAppointmentAnimal">Animal</label>
                                        <select 
                                            id="adminAppointmentAnimal" 
                                            v-model="adminAppointmentForm.selectedAnimalId"
                                            required>
                                            <option value="">Sélectionnez un animal</option>
                                            <option v-for="animal in clientAnimals" 
                                                    :key="animal.id" 
                                                    :value="animal.id">
                                                {{ animal.name }} ({{ animal.species }})
                                            </option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label for="adminAppointmentPhone">Numéro de téléphone</label>
                                        <input 
                                            type="tel" 
                                            id="adminAppointmentPhone" 
                                            v-model="adminAppointmentForm.phone"
                                            pattern="[0-9]{10}"
                                            placeholder="0612345678"
                                            required>
                                        <small>Format: 10 chiffres (ex: 0612345678)</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="adminAppointmentDate">Date du rendez-vous</label>
                                        <div v-if="isLoadingDates" class="loading-message">
                                            Chargement des dates disponibles...
                                        </div>
                                        <div v-else-if="availableDates.length === 0" class="no-slots-message">
                                            Aucune date disponible pour les 30 prochains jours.
                                        </div>
                                        <select v-else
                                            id="adminAppointmentDate" 
                                            v-model="adminAppointmentForm.date" 
                                            required>
                                            <option value="">Sélectionnez une date</option>
                                            <option v-for="date in availableDates" 
                                                    :key="date" 
                                                    :value="date">
                                                {{ formatDateFr(date) }}
                                            </option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label>Heure du rendez-vous</label>
                                        <div v-if="displayedTimeSlots.length === 0" class="no-slots-message">
                                            Aucun créneau disponible pour cette date.
                                        </div>
                                        <div v-else class="time-slots">
                                            <button v-for="slot in displayedTimeSlots" 
                                                 :key="slot"
                                                 type="button"
                                                 class="time-slot"
                                                 :class="{ 'selected': adminAppointmentForm.time === slot }"
                                                 @click="adminAppointmentForm.time = slot">
                                                {{ slot }}
                                            </button>
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="adminAppointmentNotes">Notes</label>
                                        <textarea 
                                            id="adminAppointmentNotes" 
                                            v-model="adminAppointmentForm.notes" 
                                            rows="3">
                                        </textarea>
                                    </div>

                                    <div class="modal-actions">
                                        <button type="button" 
                                                class="btn secondary" 
                                                @click="cancelAdminAppointment">
                                            Annuler
                                        </button>
                                        <button type="submit" 
                                                class="btn primary">
                                            Confirmer le rendez-vous
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Onglet Créneaux -->
                    <div v-if="adminActiveTab === 'slots'" class="admin-content">
                            <div class="slots-header">
                                <h2>Gestion des créneaux horaires</h2>
                                <button class="btn primary" @click="showAddSlotModal = true">
                                    Ajouter un créneau
                                </button>
                            </div>
                        <div>
                                <div class="calendar-header">
                                    <button class="btn secondary" @click="previousMonth">
                                        <
                                    </button>
                                    <h3>{{ currentMonthName }} {{ currentYear }}</h3>
                                    <button class="btn secondary" @click="nextMonth">
                                        >
                                    </button>
                                </div>
                                <div class="calendar-grid">
                                    <div class="calendar-weekday" v-for="day in weekDays" :key="day">
                                        {{ day }}
                                    </div>
                                    <div v-for="day in calendarDays" 
                                         :key="day.date"
                                         class="calendar-day"
                                         :class="{ 
                                             'today': isToday(day.date),
                                             'other-month': !isCurrentMonth(day.date),
                                             'has-slots': hasSlots(day.date)
                                         }"
                                         @click="selectDate(day.date)">
                                        {{ day.day }}
                                        <div class="day-slots" v-if="hasSlots(day.date)">
                                            {{ getSlotsCount(day.date) }} créneau(s)
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <div v-if="selectedDate">
                                <h3>Créneaux du {{ formatDate(selectedDate) }}</h3>
                                <div class="slots-actions">
                                    <button class="btn primary" @click="showAddSlotModal = true">
                                        Ajouter un créneau
                                    </button>
                                    <button class="btn secondary" @click="selectedDate = null">
                                        Fermer
                                    </button>
                                </div>
                                <div class="time-slots-grid">
                                    <div v-for="slot in getDateSlots(selectedDate)" 
                                         :key="slot.id"
                                         class="time-slot-card"
                                         :class="{ 'unavailable': slot.unavailable }">
                                        <div class="slot-time">{{ slot.time }}</div>
                                        <div class="slot-status">{{ slot.unavailable ? 'Indisponible' : 'Disponible' }}</div>
                                        <div class="slot-actions">
                                            <button class="btn-edit" @click="toggleSlotAvailability(slot)">
                                                {{ slot.unavailable ? 'Rendre disponible' : 'Rendre indisponible' }}
                                            </button>
                                            <button class="btn-delete" @click="deleteSlot(slot)">
                                                Supprimer
                                            </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Onglet Clients -->
                    <div v-if="adminActiveTab === 'clients'" class="admin-content">
                        <div class="search-bar">
                            <input 
                                type="text" 
                                v-model="clientsSearch" 
                                placeholder="Rechercher un client...">
                        </div>

                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Prénom</th>
                                    <th>Email</th>
                                    <th>Date d'inscription</th>
                                    <th>Nombre d'animaux</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="client in filteredClients" :key="client.id">
                                    <td>{{ client.lastName || 'N/A' }}</td>
                                    <td>{{ client.firstName || 'N/A' }}</td>
                                    <td>{{ client.email }}</td>
                                    <td>{{ formatDate(client.createdAt) }}</td>
                                    <td>{{ client.animalsCount }}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-view" @click="viewClientAnimals(client)">
                                                Voir les dossiers
                                            </button>
                                            <button class="btn-edit" @click="editClient(client)">
                                                Modifier
                                            </button>
                                            <button class="btn-delete" @click="deleteClient(client)">
                                                Supprimer
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr v-if="filteredClients.length === 0">
                                    <td colspan="6" class="text-center">Aucun client trouvé</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Onglet Messages -->
                    <div v-if="adminActiveTab === 'messages'" class="admin-content">
                        <div class="search-bar">
                            <input 
                                type="text" 
                                v-model="messagesSearch" 
                                placeholder="Rechercher un message...">
                        </div>

                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Nom</th>
                                    <th>Email</th>
                                    <th>Message</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="message in filteredMessages" :key="message.id" :class="{ 'unread': message.status === 'unread' }">
                                    <td>{{ formatDate(message.createdAt) }}</td>
                                    <td>{{ message.name }}</td>
                                    <td>{{ message.email }}</td>
                                    <td>{{ message.message }}</td>
                                    <td>
                                        <span :class="['status-badge', message.status]">
                                            {{ message.status === 'unread' ? 'Non lu' : 'Lu' }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <button class="btn-view" @click="toggleMessageStatus(message)">
                                                {{ message.status === 'unread' ? 'Marquer comme lu' : 'Marquer comme non lu' }}
                                            </button>
                                            <button class="btn-delete" @click="deleteMessage(message)">
                                                Supprimer
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <tr v-if="filteredMessages.length === 0">
                                    <td colspan="6" class="text-center">Aucun message trouvé</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </template>

            <!-- Page de profil client -->
            <template v-if="currentPage === 'profile'">
                <section class="profile-page">
                    <div class="profile-header">
                        <h1>Mon Profil</h1>
                        <p>Gérez vos informations personnelles et votre mot de passe</p>
                    </div>

                    <div class="profile-content">
                        <div v-if="profileSuccess" class="success-message">
                            <h3>Profil mis à jour avec succès</h3>
                            <p>Vos informations ont été modifiées avec succès.</p>
                        </div>
                        
                        <div v-if="profileError" class="error-message">
                            {{ profileError }}
                        </div>

                        <form @submit.prevent="updateProfile" class="profile-form">
                            <div class="profile-section">
                                <h3>Informations personnelles</h3>
                                
                                <div class="form-group">
                                    <label for="profileFirstName">Prénom</label>
                                    <input type="text" id="profileFirstName" v-model="profileForm.firstName" required>
                                </div>

                                <div class="form-group">
                                    <label for="profileLastName">Nom</label>
                                    <input type="text" id="profileLastName" v-model="profileForm.lastName" required>
                                </div>

                                <div class="form-group">
                                    <label for="profileEmail">Email</label>
                                    <input type="email" id="profileEmail" v-model="profileForm.email" required>
                                </div>

                                <div class="form-group">
                                    <label for="profileAddress">Adresse complète</label>
                                    <textarea id="profileAddress" v-model="profileForm.address" rows="3" required></textarea>
                                </div>
                            </div>

                            <div class="profile-section">
                                <h3>Modifier le mot de passe</h3>
                                <p class="password-info">Laissez vide si vous ne souhaitez pas changer votre mot de passe</p>
                                
                                <div class="form-group">
                                    <label for="profileCurrentPassword">Mot de passe actuel</label>
                                    <input type="password" id="profileCurrentPassword" v-model="profileForm.currentPassword">
                                </div>

                                <div class="form-group">
                                    <label for="profileNewPassword">Nouveau mot de passe</label>
                                    <input type="password" id="profileNewPassword" v-model="profileForm.newPassword" 
                                           :disabled="!profileForm.currentPassword">
                                </div>

                                <div class="form-group">
                                    <label for="profileConfirmPassword">Confirmer le nouveau mot de passe</label>
                                    <input type="password" id="profileConfirmPassword" v-model="profileForm.confirmPassword" 
                                           :disabled="!profileForm.currentPassword">
                                </div>
                            </div>

                            <div class="profile-actions">
                                <button type="submit" class="btn primary" :disabled="isUpdatingProfile">
                                    <span v-if="isUpdatingProfile">Mise à jour...</span>
                                    <span v-else>Sauvegarder les modifications</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </section>
            </template>
        </div>

        <footer class="footer">
            <div class="footer-content">
                <div class="footer-section">
                    <p>&copy; 2025 Thérapeute manuelle. Tous droits réservés.</p>
                </div>
            </div>
        </footer>

        <!-- Bouton flottant du tutoriel -->
        <button class="tutorial-btn" @click="startTutorial" v-if="!showAuth && !isAdmin">
            <i>?</i>
        </button>

        <!-- Composant du tutoriel -->
        <template v-if="showTutorial && !isAdmin">
            <div class="tutorial-overlay" @click="skipTutorial"></div>
            <div class="tutorial-step" :style="currentTutorialStep.position">
                <h3>{{ currentTutorialStep.title }}</h3>
                <p>{{ currentTutorialStep.content }}</p>
                <div class="btn-group">
                    <button class="btn-skip" @click="skipTutorial">Passer</button>
                    <button class="btn-next" @click="nextTutorialStep" v-if="!isLastTutorialStep">
                        Suivant
                    </button>
                    <button class="btn-next" @click="skipTutorial" v-else>
                        Terminer
                    </button>
                </div>
            </div>
        </template>

        <!-- Modal d'authentification -->
        <div v-if="showAuth" class="auth-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center;">
            <div class="auth-form">
                <h3>{{ isLogin ? 'Connexion' : 'Inscription' }}</h3>
                <template v-if="!isLogin">
                    <input type="text" v-model="firstName" placeholder="Prénom" required>
                    <input type="text" v-model="lastName" placeholder="Nom" required>
                    <textarea v-model="address" placeholder="Adresse complète" rows="3" required style="width: 100%; padding: 0.8rem; margin-bottom: 1rem; border: 1px solid #ddd; border-radius: 5px; font-family: inherit;"></textarea>
                </template>
                <input type="email" v-model="email" placeholder="Email">
                <input type="password" v-model="password" placeholder="Mot de passe">
                <button class="primary" @click="isLogin ? login() : register()">{{ isLogin ? 'Se connecter' : 'S\'inscrire' }}</button>
                <button class="secondary" @click="isLogin = !isLogin">{{ isLogin ? 'Créer un compte' : 'Déjà un compte ?' }}</button>
                <button class="close" @click="showAuth = false">Fermer</button>
                <p class="error" v-if="error">{{ error }}</p>
            </div>
        </div>

        <!-- Modal d'édition pour les animaux -->
        <div v-if="showEditAnimalModal" class="edit-modal">
            <div class="edit-modal-content">
                <h2>Modifier l'animal</h2>
                <form @submit.prevent="updateAnimal">
                    <div class="edit-form-group">
                        <label for="editAnimalOwner">Propriétaire</label>
                        <select id="editAnimalOwner" v-model="editingAnimal.userId" required>
                            <option v-for="client in allClients" :key="client.id" :value="client.id">
                                {{ client.firstName }} {{ client.lastName }} ({{ client.email }})
                            </option>
                        </select>
                    </div>
                    <div class="edit-form-group">
                        <label for="editAnimalName">Nom</label>
                        <input type="text" id="editAnimalName" v-model="editingAnimal.name" required>
                    </div>
                    <div class="edit-form-group">
                        <label for="editAnimalSpecies">Espèce</label>
                        <select id="editAnimalSpecies" v-model="editingAnimal.species" required>
                            <option value="">Sélectionnez une espèce</option>
                            <option value="chien">Chien</option>
                            <option value="chat">Chat</option>
                            <option value="cheval">Cheval</option>
                            <option value="autre">Autre</option>
                        </select>
                    </div>
                    <div class="edit-form-group">
                        <label for="editAnimalRace">Race</label>
                        <input type="text" id="editAnimalRace" v-model="editingAnimal.race">
                    </div>
                    <div class="edit-form-group">
                        <label for="editAnimalBirthdate">Date de naissance</label>
                        <input type="date" id="editAnimalBirthdate" v-model="editingAnimal.birthdate" required>
                    </div>
                    <div class="edit-form-group">
                        <label for="editAnimalNotes">Notes</label>
                        <textarea id="editAnimalNotes" v-model="editingAnimal.notes" rows="3"></textarea>
                    </div>
                    <div class="edit-modal-actions">
                        <button type="button" class="btn secondary" @click="showEditAnimalModal = false">Annuler</button>
                        <button type="submit" class="btn primary">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal d'édition pour les rendez-vous -->
        <div v-if="showEditAppointmentModal" class="edit-modal">
            <div class="edit-modal-content">
                <h2>Modifier le rendez-vous</h2>
                <form @submit.prevent="updateAppointment">
                    <div class="edit-form-group">
                        <label for="editAppointmentDate">Date</label>
                        <input type="date" id="editAppointmentDate" v-model="editingAppointment.date" required>
                    </div>
                    <div class="edit-form-group">
                        <label>Heure</label>
                        <div class="time-slots">
                            <button v-for="slot in timeSlots" 
                                 :key="slot"
                                 type="button"
                                 class="time-slot"
                                 :class="{ 
                                     'selected': editingAppointment.time === slot,
                                     'unavailable': isTimeSlotUnavailable(slot) && editingAppointment.time !== slot
                                 }"
                                 @click="!isTimeSlotUnavailable(slot) && (editingAppointment.time = slot)">
                                {{ slot }}
                            </button>
                        </div>
                    </div>
                    <div class="edit-form-group">
                        <label for="editAppointmentPhone">Numéro de téléphone</label>
                        <input type="tel" id="editAppointmentPhone" v-model="editingAppointment.phone" 
                               pattern="[0-9]{10}" 
                               placeholder="0612345678" 
                               required>
                        <small style="color: var(--text-color); font-size: 0.8rem;">Format: 10 chiffres (ex: 0612345678)</small>
                    </div>
                    <div class="edit-form-group">
                        <label for="editAppointmentNotes">Notes</label>
                        <textarea id="editAppointmentNotes" v-model="editingAppointment.notes" rows="3"></textarea>
                    </div>
                    <div class="edit-modal-actions">
                        <button type="button" class="btn secondary" @click="showEditAppointmentModal = false">Annuler</button>
                        <button type="submit" class="btn primary">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal d'ajout de créneau -->
        <div v-if="showAddSlotModal" class="edit-modal">
            <div class="edit-modal-content">
                <h2>{{ selectedDate ? 'Ajouter un créneau' : 'Ajouter des créneaux' }}</h2>
                <form @submit.prevent="addSlots">
                    <div class="edit-form-group">
                        <label for="slotTime">Heure</label>
                        <input type="time" id="slotTime" v-model="newSlot.time" required>
                    </div>
                    <div class="edit-form-group">
                        <label for="slotDuration">Durée (minutes)</label>
                        <select id="slotDuration" v-model="newSlot.duration" required>
                            <option value="30">30 minutes</option>
                            <option value="45">45 minutes</option>
                            <option value="60">1 heure</option>
                            <option value="90">1 heure 30</option>
                            <option value="120">2 heures</option>
                        </select>
                    </div>
                    <div class="edit-form-group">
                        <label for="slotDate">Date de début</label>
                        <input type="date" id="slotDate" v-model="newSlot.date" required 
                               :min="minDate">
                    </div>
                    <div class="edit-form-group">
                        <label for="slotRecurrence">Récurrence</label>
                        <select id="slotRecurrence" v-model="newSlot.recurrence">
                            <option value="none">Aucune</option>
                            <option value="daily">Tous les jours</option>
                            <option value="weekly">Toutes les semaines</option>
                            <option value="monthly">Tous les mois</option>
                        </select>
                    </div>
                    <div class="edit-form-group" v-if="newSlot.recurrence !== 'none'">
                        <label for="slotEndDate">Date de fin</label>
                        <input type="date" id="slotEndDate" v-model="newSlot.endDate" required
                               :min="newSlot.date">
                    </div>
                    <div class="edit-modal-actions">
                        <button type="button" class="btn secondary" @click="showAddSlotModal = false">Annuler</button>
                        <button type="submit" class="btn primary">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal d'édition pour les clients -->
        <div v-if="showEditClientModal" class="edit-modal">
            <div class="edit-modal-content">
                <h2>Modifier le client</h2>
                <form @submit.prevent="updateClient">
                    <div class="edit-form-group">
                        <label for="editClientFirstName">Prénom</label>
                        <input type="text" id="editClientFirstName" v-model="editingClient.firstName" required>
                    </div>
                    <div class="edit-form-group">
                        <label for="editClientLastName">Nom</label>
                        <input type="text" id="editClientLastName" v-model="editingClient.lastName" required>
                    </div>
                    <div class="edit-form-group">
                        <label for="editClientEmail">Email</label>
                        <input type="email" id="editClientEmail" v-model="editingClient.email" required>
                    </div>
                    <div class="edit-form-group">
                        <label for="editClientAddress">Adresse</label>
                        <textarea id="editClientAddress" v-model="editingClient.address" rows="3" required></textarea>
                    </div>
                    <div class="edit-modal-actions">
                        <button type="button" class="btn secondary" @click="showEditClientModal = false">Annuler</button>
                        <button type="submit" class="btn primary">Enregistrer</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Modal pour voir les dossiers d'animaux d'un client -->
        <div v-if="showClientAnimalsModal" class="modal">
            <div class="modal-content" style="max-width: 900px;">
                <h2>Dossiers des animaux de {{ selectedClient ? (selectedClient.firstName + ' ' + selectedClient.lastName) : '' }}</h2>
                
                <div class="animals-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
                    <div v-for="animal in clientAnimals" :key="animal.id" class="animal-card">
                        <div class="animal-info">
                            <div v-if="animal.photos && animal.photos.length > 0" class="animal-photos-container">
                                <img :src="animal.photos[0]" :alt="animal.name" class="animal-photo">
                                <div v-if="animal.photos.length > 1" class="photo-count-badge">
                                    +{{ animal.photos.length - 1 }}
                                </div>
                            </div>
                            <div v-else-if="animal.photoBase64" class="animal-photo-container">
                                <img :src="animal.photoBase64" :alt="animal.name" class="animal-photo">
                            </div>
                            <div v-else class="animal-photo placeholder">
                                <span>Pas de photo</span>
                            </div>
                            <h3>{{ animal.name }}</h3>
                            <p class="animal-birthdate">Né le: {{ formatDate(animal.birthdate) }}</p>
                            <p v-if="animal.notes" class="animal-notes">{{ animal.notes }}</p>
                        </div>
                        <div class="animal-actions">
                            <button class="btn" @click="viewAnimalDetails(animal)">Voir le dossier</button>
                        </div>
                    </div>
                    <div v-if="clientAnimals.length === 0" class="no-animals" style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                        <p>Ce client n'a pas encore d'animaux enregistrés.</p>
                    </div>
                </div>

                <div class="modal-actions" style="margin-top: 2rem;">
                    <button class="btn secondary" @click="showClientAnimalsModal = false">Fermer</button>
                </div>
            </div>
        </div>

        <!-- Modal d'ajout/modification d'article -->
        <div v-if="showAddPostModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <h2>{{ editingPost ? 'Modifier l\'article' : 'Nouvel article' }}</h2>
                <form @submit.prevent="addBlogPost" class="blog-form">
                    <div class="form-group">
                        <label for="postTitle">Titre</label>
                        <input type="text" id="postTitle" v-model="newPost.title" required>
                    </div>
                    <div class="form-group">
                        <label for="postDate">Date de publication</label>
                        <input type="date" id="postDate" v-model="newPost.date" required>
                    </div>
                    <div class="form-group">
                        <label for="postImage">URL de l'image</label>
                        <input type="url" id="postImage" v-model="newPost.imageUrl" required>
                    </div>
                    <div class="form-group">
                        <label for="postExcerpt">Extrait (résumé court)</label>
                        <textarea id="postExcerpt" v-model="newPost.excerpt" rows="2" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="postContent">Contenu</label>
                        <textarea id="postContent" v-model="newPost.content" rows="10" required></textarea>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn secondary" @click="showAddPostModal = false">Annuler</button>
                        <button type="submit" class="btn primary">{{ editingPost ? 'Mettre à jour' : 'Publier' }}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const { createApp, watch } = Vue

        // Configuration Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyB9noXR2BudT0VMELFTvnjthCfTA4pxVgU",
            authDomain: "osteopatheanimalier-50728.firebaseapp.com",
            projectId: "osteopatheanimalier-50728",
            storageBucket: "osteopatheanimalier-50728.firebasestorage.app",
            messagingSenderId: "9417853053",
            appId: "1:9417853053:web:ee7ba42a04e8b6f27cc914",
            measurementId: "G-79QK6LZGNC"
        };

        // Initialisation de Firebase
        const app = firebase.initializeApp(firebaseConfig);
        
        // Configuration de Firestore avec gestion d'erreurs
        const db = firebase.firestore();
        
        // Désactiver le mode émulateur en production
        if (window.location.hostname === "localhost") {
            console.log("Mode développement - Utilisation de l'émulateur Firestore");
            db.useEmulator("localhost", 8080);
        }

        // Configuration des paramètres de Firestore
        db.settings({
            cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
            merge: true,
            ignoreUndefinedProperties: true
        });

        // Gestion des erreurs de connexion
        db.enablePersistence()
            .catch((err) => {
                if (err.code === 'failed-precondition') {
                    console.warn("Le mode hors ligne n'est pas disponible avec plusieurs onglets ouverts");
                } else if (err.code === 'unimplemented') {
                    console.warn("Le navigateur ne supporte pas le mode hors ligne");
                }
            });

        const functions = firebase.functions();

        createApp({
            data() {
                return {
                    currentPage: 'home',
                    message: 'Ostéopathe Animalier',
                    email: '',
                    password: '',
                    firstName: '',
                    lastName: '',
                    address: '',
                    error: '',
                    isAuthenticated: false,
                    userEmail: '',
                    showAuth: false,
                    isLogin: true,
                    isMenuOpen: false,
                    contactForm: {
                        name: '',
                        email: '',
                        message: ''
                    },
                    appointmentForm: {
                        consultationType: '',
                        animalType: '',
                        animalName: '',
                        date: '',
                        time: '',
                        notes: '',
                        phone: '',
                        selectedAnimalId: ''
                    },
                    appointmentSuccess: false,
                    appointmentError: '',
                    timeSlots: [
                        '09:00', '10:00', '11:00', '14:00', '15:00', '16:00', '17:00'
                    ],
                    availableSlots: [],
                    unavailableSlots: [],
                    animals: [],
                    showAddAnimalModal: false,
                    newAnimal: {
                        name: '',
                        species: '',
                        race: '',
                        birthdate: '',
                        sterilization: false,
                        sterilizationDetails: '',
                        diet: '',
                        activity: '',
                        activityDetails: '',
                        medicalHistory: '',
                        treatment: '',
                        behavior: '',
                        notes: '',
                        photoUrl: '',
                        photoPreview: '',
                        photoBase64: null,
                        documents: [],
                        appointments: [],
                        travelTime: '' // Ajout du champ temps de trajet
                    },
                    unsubscribeAnimals: null,
                    isAdmin: false,
                    adminActiveTab: 'animals',
                    adminSearch: '',
                    animalsSearch: '',
                    appointmentsSearch: '',
                    clientsSearch: '',
                    messagesSearch: '',
                    allAnimals: [],
                    allAppointments: [],
                    userEmails: {},
                    showEditAnimalModal: false,
                    showEditAppointmentModal: false,
                    editingAnimal: null,
                    editingAppointment: null,
                    currentMonth: new Date().getMonth(),
                    currentYear: new Date().getFullYear(),
                    selectedDate: null,
                    showAddSlotModal: false,
                    newSlot: {
                        time: '',
                        date: '',
                        duration: '60',
                        recurrence: 'none',
                        endDate: ''
                    },
                    weekDays: ['Dim', 'Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam'],
                    slots: [],
                    availableDates: [],
                    isLoadingDates: false,
                    unsubscribeSlots: null,
                    unsubscribeAppointments: null,
                    unsubscribeAdminSlots: null,
                    unsubscribeAvailableDates: null,
                    editingClient: null,
                    showEditClientModal: false,
                    showClientAnimalsModal: false,
                    selectedClient: null,
                    clientAnimals: [],
                    messages: [],
                    unreadMessagesCount: 0,
                    unsubscribeMessages: null,
                    allClients: [], // Ajouter allClients dans data
                    clientsData: [], // Nouvelle propriété pour stocker les données brutes des clients
                    // Données pour le tutoriel
                    showTutorial: false,
                    currentTutorialStepIndex: 0,
                    tutorialSteps: [
                        {
                            title: "Bienvenue !",
                            content: "Je vais vous guider à travers les principales fonctionnalités de l'application.",
                            position: {
                                top: '50%',
                                left: '50%',
                                transform: 'translate(-50%, -50%)'
                            }
                        },
                        {
                            title: "Créer un compte",
                            content: "Pour commencer, créez un compte ou connectez-vous en cliquant sur 'Connexion' dans le menu.",
                            position: {
                                top: '80px',
                                right: '20px'
                            }
                        },
                        {
                            title: "Dossier ostéopathique",
                            content: "Une fois connecté, accédez à votre dossier ostéopathique pour gérer vos animaux.",
                            position: {
                                top: '80px',
                                right: '150px'
                            }
                        },
                        {
                            title: "Ajouter un animal",
                            content: "Dans votre dossier, vous pourrez ajouter vos animaux et suivre leur historique de soins.",
                            position: {
                                top: '50%',
                                left: '50%',
                                transform: 'translate(-50%, -50%)'
                            }
                        },
                        {
                            title: "Prendre rendez-vous",
                            content: "Une fois votre animal ajouté, vous pourrez facilement prendre rendez-vous en quelques clics.",
                            position: {
                                top: '80px',
                                right: '250px'
                            }
                        }
                    ],
                    isMobile: window.innerWidth <= 768,
                    blogPosts: [],
                    showAddPostModal: false,
                    newPost: {
                        title: '',
                        content: '',
                        excerpt: '',
                        imageUrl: '',
                        date: new Date().toISOString().split('T')[0]
                    },
                    unsubscribeBlogPosts: null,
                    editingPost: null,
                    appointmentsView: 'list',
                    sortField: 'date',
                    sortOrder: 'asc',
                    showAdminNewAppointmentModal: false,
                    adminAppointmentForm: {
                        userId: '',
                        selectedAnimalId: '',
                        phone: '',
                        date: '',
                        time: '',
                        notes: ''
                    },
                    // Données pour la page de profil
                    profileForm: {
                        firstName: '',
                        lastName: '',
                        email: '',
                        address: '',
                        currentPassword: '',
                        newPassword: '',
                        confirmPassword: ''
                    },
                    profileSuccess: false,
                    profileError: '',
                    isUpdatingProfile: false
                }
            },
            computed: {
                minDate() {
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    return tomorrow.toISOString().split('T')[0];
                },
                maxDate() {
                    const max = new Date();
                    max.setDate(max.getDate() + 30);
                    return max.toISOString().split('T')[0];
                },
                filteredAnimals() {
                    if (!this.animalsSearch) return this.allAnimals;
                    const search = this.animalsSearch.toLowerCase();
                    return this.allAnimals.filter(animal => 
                        (animal.name || '').toLowerCase().includes(search) ||
                        (animal.species || '').toLowerCase().includes(search) ||
                        (this.getUserFullName(animal.userId) || '').toLowerCase().includes(search)
                    );
                },
                filteredAppointments() {
                    if (!this.appointmentsSearch) return this.allAppointments;
                    const search = this.appointmentsSearch.toLowerCase();
                    return this.allAppointments.filter(apt => 
                        (apt.animalName || '').toLowerCase().includes(search) ||
                        (this.getUserFullName(apt.userId) || '').toLowerCase().includes(search)
                    );
                },
                currentMonthName() {
                    return new Date(this.currentYear, this.currentMonth).toLocaleString('fr-FR', { month: 'long' });
                },
                calendarDays() {
                    const firstDay = new Date(this.currentYear, this.currentMonth, 1);
                    const lastDay = new Date(this.currentYear, this.currentMonth + 1, 0);
                    const days = [];
                    
                    // Ajouter les jours du mois précédent
                    const prevMonthDays = firstDay.getDay();
                    const prevMonth = new Date(this.currentYear, this.currentMonth, 0);
                    for (let i = prevMonthDays - 1; i >= 0; i--) {
                        days.push({
                            date: new Date(this.currentYear, this.currentMonth - 1, prevMonth.getDate() - i),
                            day: prevMonth.getDate() - i,
                            isCurrentMonth: false
                        });
                    }
                    
                    // Ajouter les jours du mois courant
                    for (let i = 1; i <= lastDay.getDate(); i++) {
                        days.push({
                            date: new Date(this.currentYear, this.currentMonth, i),
                            day: i,
                            isCurrentMonth: true
                        });
                    }
                    
                    // Ajouter les jours du mois suivant
                    const nextMonthDays = 42 - days.length; // 6 semaines * 7 jours
                    for (let i = 1; i <= nextMonthDays; i++) {
                        days.push({
                            date: new Date(this.currentYear, this.currentMonth + 1, i),
                            day: i,
                            isCurrentMonth: false
                        });
                    }
                    
                    return days;
                },
                displayedTimeSlots() {
                    // Utiliser la date du formulaire actif (admin ou client)
                    const selectedDate = this.adminAppointmentForm.date || this.appointmentForm.date;
                    if (!selectedDate) return [];
                    
                    // Retourner les créneaux disponibles pour la date sélectionnée
                    return this.availableSlots || [];
                },
                filteredMessages() {
                    if (!this.messagesSearch) return this.messages;
                    const search = this.messagesSearch.toLowerCase();
                    return this.messages.filter(message => 
                        message.name.toLowerCase().includes(search) ||
                        message.email.toLowerCase().includes(search) ||
                        message.message.toLowerCase().includes(search)
                    );
                },
                filteredClients() {
                    if (!this.clientsSearch) return this.allClients;
                    const search = this.clientsSearch.toLowerCase();
                    return this.allClients.filter(client => 
                        (client.lastName || '').toLowerCase().includes(search) ||
                        (client.firstName || '').toLowerCase().includes(search) ||
                        client.email.toLowerCase().includes(search)
                    );
                },
                getClientAnimalsCount() {
                    return (clientId) => {
                        return this.allAnimals.filter(animal => animal.userId === clientId).length;
                    };
                },
                currentTutorialStep() {
                    return this.tutorialSteps[this.currentTutorialStepIndex];
                },
                isLastTutorialStep() {
                    return this.currentTutorialStepIndex === this.tutorialSteps.length - 1;
                },
                hasAppointments() {
                    return (date) => {
                        return this.allAppointments.some(appointment => {
                            const appointmentDate = new Date(appointment.date);
                            return appointmentDate.toDateString() === date.toDateString();
                        });
                    };
                },
                getAppointmentsCount() {
                    return (date) => {
                        return this.allAppointments.filter(appointment => {
                            const appointmentDate = new Date(appointment.date);
                            return appointmentDate.toDateString() === date.toDateString();
                        }).length;
                    };
                },
                getDayAppointments() {
                    return (date) => {
                        return this.allAppointments
                            .filter(appointment => {
                                const appointmentDate = new Date(appointment.date);
                                return appointmentDate.toDateString() === date.toDateString();
                            })
                            .sort((a, b) => {
                                // Convertir les heures en minutes pour faciliter la comparaison
                                const timeA = a.time.split(':').map(Number);
                                const timeB = b.time.split(':').map(Number);
                                const minutesA = timeA[0] * 60 + timeA[1];
                                const minutesB = timeB[0] * 60 + timeB[1];
                                return minutesA - minutesB;
                            });
                    };
                },
                sortedAppointments() {
                    return this.filteredAppointments.slice().sort((a, b) => {
                        if (this.sortOrder === 'asc') {
                            return new Date(a.date) - new Date(b.date);
                        } else {
                            return new Date(b.date) - new Date(a.date);
                        }
                    });
                }
            },
            watch: {
                'appointmentForm.date': {
                    immediate: true,
                    async handler(newDate) {
                        if (newDate) {
                            await this.loadUnavailableSlots();
                        }
                    }
                },
                'adminAppointmentForm.date': {
                    immediate: true,
                    async handler(newDate) {
                        if (newDate) {
                            await this.loadUnavailableSlots();
                        }
                    }
                },
                'newAnimal.sterilization': {
                    handler(newValue) {
                        // Gérer l'affichage du champ de détails de stérilisation
                        this.$nextTick(() => {
                            const detailsField = document.getElementById('newAnimalSterilizationDetails');
                            if (detailsField) {
                                const parentGroup = detailsField.closest('.form-group');
                                if (parentGroup) {
                                    parentGroup.style.display = newValue ? 'block' : 'none';
                                }
                            }
                        });
                    }
                },
                currentPage() {
                    setTimeout(() => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 100);
                    
                    // Recharger les créneaux si on va sur la page de rendez-vous
                    if (this.currentPage === 'appointment' && this.isAuthenticated) {
                        setTimeout(() => {
                            this.loadAvailableDates();
                        }, 200);
                    }
                },
                adminActiveTab() {
                    // Recharger les créneaux quand on va sur l'onglet Créneaux
                    if (this.adminActiveTab === 'slots' && this.isAdmin) {
                        setTimeout(() => {
                            this.loadSlots();
                        }, 100);
                    }
                },
            },
            methods: {
                toggleMenu() {
                    this.isMenuOpen = !this.isMenuOpen;
                },
                closeMenu() {
                    this.isMenuOpen = false;
                },
                async login() {
                    try {
                        const userCredential = await firebase.auth().signInWithEmailAndPassword(this.email, this.password);
                        
                        // Liste des IDs administrateurs
                        const adminIds = ['4tYIuGIeMMMG7Wbv6OXjkeKOURI3', 'Rdzwjl02KwaNdgbISONjs0rPBQy1'];
                        
                        // Vérifier si le document utilisateur existe, sinon le créer
                        const userDoc = await db.collection('users').doc(userCredential.user.uid).get();
                        if (!userDoc.exists) {
                            await db.collection('users').doc(userCredential.user.uid).set({
                                email: userCredential.user.email,
                                role: adminIds.includes(userCredential.user.uid) ? 'admin' : 'user',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }

                        this.isAuthenticated = true;
                        this.userEmail = userCredential.user.email;
                        this.error = '';
                        this.showAuth = false;

                        // Vérifier si l'utilisateur est admin
                        await this.checkAdminStatus();
                    } catch (error) {
                        this.error = error.message;
                    }
                },
                async register() {
                    try {
                        if (!this.firstName || !this.lastName) {
                            this.error = 'Le nom et le prénom sont requis';
                            return;
                        }
                        if (!this.address) {
                            this.error = 'L\'adresse est requise';
                            return;
                        }
                        const userCredential = await firebase.auth().createUserWithEmailAndPassword(this.email, this.password);
                        
                        // Liste des IDs administrateurs
                        const adminIds = ['4tYIuGIeMMMG7Wbv6OXjkeKOURI3', 'Rdzwjl02KwaNdgbISONjs0rPBQy1'];
                        
                        // Créer un document utilisateur dans Firestore
                        await db.collection('users').doc(userCredential.user.uid).set({
                            email: userCredential.user.email,
                            firstName: this.firstName,
                            lastName: this.lastName,
                            address: this.address,
                            role: adminIds.includes(userCredential.user.uid) ? 'admin' : 'user',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        this.isAuthenticated = true;
                        this.userEmail = userCredential.user.email;
                        this.error = '';
                        this.showAuth = false;

                        // Réinitialiser les champs
                        this.firstName = '';
                        this.lastName = '';
                        this.address = '';
                        this.email = '';
                        this.password = '';

                        // Vérifier si l'utilisateur est admin
                        await this.checkAdminStatus();
                    } catch (error) {
                        this.error = error.message;
                    }
                },
                // Méthode pour mettre à jour l'affichage des photos
                updatePhotosDisplay(modal, photos) {
                    const photosGrid = modal.querySelector('.photos-grid');
                    if (photosGrid) {
                        if (photos.length > 0) {
                            photosGrid.innerHTML = photos.map((photo, index) => `
                                <div class="photo-item">
                                    <img src="${photo}" alt="Photo de l'animal" class="animal-photo">
                                    <button type="button" class="btn-remove-photo" data-index="${index}">×</button>
                                </div>
                            `).join('');
                            
                            // Ajouter les gestionnaires d'événements pour les boutons de suppression
                            const removeButtons = photosGrid.querySelectorAll('.btn-remove-photo');
                            removeButtons.forEach(button => {
                                button.addEventListener('click', (e) => {
                                    e.preventDefault();
                                    const index = parseInt(button.getAttribute('data-index'));
                                    // Déclencher l'événement de suppression
                                    modal.dispatchEvent(new CustomEvent('delete-photo', { detail: index }));
                                });
                            });
                        } else {
                            photosGrid.innerHTML = '<p>Aucune photo</p>';
                        }
                    }
                },
                async logout() {
                    try {
                        // Nettoyer l'abonnement aux mises à jour en temps réel
                        if (this.unsubscribeAnimals) {
                            this.unsubscribeAnimals();
                            this.unsubscribeAnimals = null;
                        }
                        
                        // Réinitialiser les données
                        this.animals = [];
                        this.isAuthenticated = false;
                        this.isAdmin = false;
                        this.userEmail = '';
                        this.email = '';
                        this.password = '';
                        
                        // Cacher le bouton de notification
                        const bellContainer = document.querySelector('#onesignal-bell-container');
                        if (bellContainer) {
                            bellContainer.classList.remove('show-bell');
                        }
                        
                        // Attendre un court instant pour s'assurer que les données sont nettoyées
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                        // Effectuer la déconnexion
                        await firebase.auth().signOut();
                        
                        // Rediriger vers la page d'accueil
                        window.location.hash = '';
                        this.currentPage = 'home';
                    } catch (error) {
                        console.error('Error during logout:', error);
                        this.error = error.message;
                    }
                },
                async sendMessage() {
                    // Vérification des champs requis
                    if (!this.contactForm.name || !this.contactForm.email || !this.contactForm.message) {
                        alert('Veuillez remplir tous les champs du formulaire.');
                        return;
                    }

                    // Vérification basique du format email
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(this.contactForm.email)) {
                        alert('Veuillez entrer une adresse email valide.');
                        return;
                    }

                    try {
                        const messageData = {
                            name: this.contactForm.name,
                            email: this.contactForm.email,
                            message: this.contactForm.message,
                            status: 'unread',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            userId: firebase.auth().currentUser ? firebase.auth().currentUser.uid : null
                        };

                        // Sauvegarder le message dans Firebase
                        const messageRef = await db.collection('contact_messages').add(messageData);

                        // Envoyer une notification aux administrateurs via OneSignal
                        const notificationData = {
                            app_id: "c1dcb08f-cad7-4f3e-be08-b45671fbde82",
                            contents: {
                                en: `Nouveau message de ${this.contactForm.name}`,
                                fr: `Nouveau message de ${this.contactForm.name}`
                            },
                            headings: {
                                en: "Nouveau message de contact",
                                fr: "Nouveau message de contact"
                            },
                            subtitle: {
                                en: `Email: ${this.contactForm.email}`,
                                fr: `Email: ${this.contactForm.email}`
                            },
                            url: window.location.origin + "/#admin", // Lien vers la section admin
                            // Envoyer uniquement aux administrateurs via les tags
                            filters: [
                                {"field": "tag", "key": "role", "relation": "=", "value": "admin"}
                            ],
                            // Ajouter des données personnalisées
                            data: {
                                type: "contact_message",
                                messageId: messageRef.id,
                                senderName: this.contactForm.name,
                                senderEmail: this.contactForm.email
                            }
                        };

                        try {
                            // Envoyer la notification via l'API REST de OneSignal
                            const response = await fetch('https://onesignal.com/api/v1/notifications', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': 'Basic os_v2_app_yholbd6k25ht5pqiwrlhd666qi2l732wdaqepxupxqcpzmldkhlya27onu2hglbn2jqpeyjshfkn4g2nj6zks2o3skyegtdpvs7e3da'
                                },
                                body: JSON.stringify(notificationData)
                            });

                            if (!response.ok) {
                                console.error('OneSignal API error:', response.status, response.statusText);
                                const errorText = await response.text();
                                console.error('OneSignal error details:', errorText);
                            } else {
                                console.log('Notification de contact envoyée avec succès');
                            }
                        } catch (notificationError) {
                            console.error('Erreur lors de l\'envoi de la notification:', notificationError);
                            // Ne pas bloquer l'envoi du message si la notification échoue
                        }

                        alert('Message envoyé ! Nous vous contacterons bientôt.');
                        this.contactForm = {
                            name: '',
                            email: '',
                            message: ''
                        };
                    } catch (error) {
                        console.error('Error sending message:', error);
                        alert('Une erreur est survenue lors de l\'envoi du message. Veuillez réessayer plus tard.');
                    }
                },
                // Méthodes pour la page de profil
                async loadProfileData() {
                    try {
                        const user = firebase.auth().currentUser;
                        if (!user) return;

                        const userDoc = await db.collection('users').doc(user.uid).get();
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            this.profileForm.firstName = userData.firstName || '';
                            this.profileForm.lastName = userData.lastName || '';
                            this.profileForm.email = userData.email || user.email || '';
                            this.profileForm.address = userData.address || '';
                        }
                    } catch (error) {
                        console.error('Erreur lors du chargement du profil:', error);
                        this.profileError = 'Erreur lors du chargement des données du profil';
                    }
                },
                async updateProfile() {
                    try {
                        this.isUpdatingProfile = true;
                        this.profileError = '';
                        this.profileSuccess = false;

                        const user = firebase.auth().currentUser;
                        if (!user) {
                            this.profileError = 'Vous devez être connecté pour modifier votre profil';
                            return;
                        }

                        // Validation des champs requis
                        if (!this.profileForm.firstName || !this.profileForm.lastName || !this.profileForm.email || !this.profileForm.address) {
                            this.profileError = 'Tous les champs sont obligatoires';
                            return;
                        }

                        // Validation du mot de passe si changement demandé
                        if (this.profileForm.currentPassword || this.profileForm.newPassword || this.profileForm.confirmPassword) {
                            if (!this.profileForm.currentPassword) {
                                this.profileError = 'Le mot de passe actuel est requis pour changer le mot de passe';
                                return;
                            }
                            if (!this.profileForm.newPassword) {
                                this.profileError = 'Le nouveau mot de passe est requis';
                                return;
                            }
                            if (this.profileForm.newPassword !== this.profileForm.confirmPassword) {
                                this.profileError = 'Les mots de passe ne correspondent pas';
                                return;
                            }
                            if (this.profileForm.newPassword.length < 6) {
                                this.profileError = 'Le mot de passe doit contenir au moins 6 caractères';
                                return;
                            }
                        }

                        // Mise à jour des informations utilisateur dans Firestore
                        const userUpdateData = {
                            firstName: this.profileForm.firstName,
                            lastName: this.profileForm.lastName,
                            email: this.profileForm.email,
                            address: this.profileForm.address,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        await db.collection('users').doc(user.uid).update(userUpdateData);

                        // Mise à jour du mot de passe si demandé
                        if (this.profileForm.currentPassword && this.profileForm.newPassword) {
                            // Réauthentifier l'utilisateur avant de changer le mot de passe
                            const credential = firebase.auth.EmailAuthProvider.credential(
                                user.email,
                                this.profileForm.currentPassword
                            );
                            await user.reauthenticateWithCredential(credential);
                            
                            // Changer le mot de passe
                            await user.updatePassword(this.profileForm.newPassword);
                        }

                        // Mettre à jour l'email dans Firebase Auth si nécessaire
                        if (this.profileForm.email !== user.email) {
                            await user.updateEmail(this.profileForm.email);
                        }

                        this.profileSuccess = true;
                        
                        // Réinitialiser les champs de mot de passe
                        this.profileForm.currentPassword = '';
                        this.profileForm.newPassword = '';
                        this.profileForm.confirmPassword = '';

                        // Masquer le message de succès après 3 secondes
                        setTimeout(() => {
                            this.profileSuccess = false;
                        }, 3000);

                    } catch (error) {
                        console.error('Erreur lors de la mise à jour du profil:', error);
                        if (error.code === 'auth/wrong-password') {
                            this.profileError = 'Le mot de passe actuel est incorrect';
                        } else if (error.code === 'auth/email-already-in-use') {
                            this.profileError = 'Cette adresse email est déjà utilisée';
                        } else if (error.code === 'auth/requires-recent-login') {
                            this.profileError = 'Pour des raisons de sécurité, veuillez vous reconnecter avant de modifier votre profil';
                        } else {
                            this.profileError = 'Une erreur est survenue lors de la mise à jour du profil';
                        }
                    } finally {
                        this.isUpdatingProfile = false;
                    }
                },
                async loadUnavailableSlots() {
                    // Déterminer quelle date utiliser en fonction du formulaire actif
                    const selectedDate = this.adminAppointmentForm.date || this.appointmentForm.date;
                    
                    if (!selectedDate) {
                        this.availableSlots = [];
                        return;
                    }
                    
                    try {
                        console.log('Loading slots for date:', selectedDate);
                        
                        // Créer les dates de début et fin de la journée sélectionnée
                        const dateObj = new Date(selectedDate);
                        const startOfDay = new Date(dateObj);
                        startOfDay.setHours(0, 0, 0, 0);
                        const endOfDay = new Date(dateObj);
                        endOfDay.setHours(23, 59, 59, 999);

                        // Nettoyer les anciens écouteurs
                        if (this.unsubscribeSlots) {
                            this.unsubscribeSlots();
                        }
                        if (this.unsubscribeAppointments) {
                            this.unsubscribeAppointments();
                        }

                        // Écouter les créneaux pour cette date
                        this.unsubscribeSlots = db.collection('timeSlots')
                            .where('date', '>=', firebase.firestore.Timestamp.fromDate(startOfDay))
                            .where('date', '<=', firebase.firestore.Timestamp.fromDate(endOfDay))
                            .onSnapshot((slotsSnapshot) => {
                                console.log('Slots snapshot:', slotsSnapshot.docs.length, 'slots found');
                                
                                // Si aucun créneau n'est défini pour cette date
                                if (slotsSnapshot.empty) {
                                    this.availableSlots = [];
                                    return;
                                }

                                // Récupérer les créneaux disponibles (non marqués comme indisponibles)
                                const availableSlots = slotsSnapshot.docs
                                    .filter(doc => !doc.data().unavailable)
                                    .map(doc => doc.data().time);

                                console.log('Available slots before appointments filter:', availableSlots);

                                // Écouter les rendez-vous pour cette date
                                this.unsubscribeAppointments = db.collection('appointments')
                                    .where('date', '==', selectedDate)
                                    .onSnapshot((appointmentsSnapshot) => {
                                        console.log('Appointments snapshot:', appointmentsSnapshot.docs.length, 'appointments found');
                                        
                                        // Récupérer les créneaux déjà réservés
                                        const bookedSlots = appointmentsSnapshot.docs
                                            .map(doc => doc.data().time);
                                        
                                        console.log('Booked slots:', bookedSlots);
                                            
                                        // Filtrer les créneaux disponibles
                                        this.availableSlots = availableSlots
                                            .filter(slot => !bookedSlots.includes(slot))
                                            .sort((a, b) => {
                                                const [aHours, aMinutes] = a.split(':').map(Number);
                                                const [bHours, bMinutes] = b.split(':').map(Number);
                                                return (aHours * 60 + aMinutes) - (bHours * 60 + bMinutes);
                                            });
                                        
                                        console.log('Final available slots:', this.availableSlots);
                                    }, error => {
                                        console.error('Error in appointments listener:', error);
                                        this.availableSlots = availableSlots;
                                    });
                            }, error => {
                                console.error('Error in slots listener:', error);
                                this.availableSlots = [];
                            });

                    } catch (error) {
                        console.error('Error loading available slots:', error);
                        this.availableSlots = [];
                    }
                },
                isTimeSlotUnavailable(slot) {
                    return this.unavailableSlots.includes(slot);
                },
                async submitAppointment() {
                    try {
                        // Vérifier si un créneau est sélectionné
                        if (!this.appointmentForm.time) {
                            this.appointmentError = 'Veuillez sélectionner un créneau horaire';
                            return;
                        }

                        // Vérifier que la date n'est pas aujourd'hui
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const selectedDate = new Date(this.appointmentForm.date);
                        selectedDate.setHours(0, 0, 0, 0);

                        if (selectedDate.getTime() === today.getTime()) {
                            this.appointmentError = 'Les rendez-vous ne peuvent pas être pris pour le jour même. Veuillez sélectionner une date ultérieure.';
                            return;
                        }

                        // Vérifier si le créneau est toujours disponible
                        const startOfDay = new Date(this.appointmentForm.date);
                        startOfDay.setHours(0, 0, 0, 0);
                        const endOfDay = new Date(this.appointmentForm.date);
                        endOfDay.setHours(23, 59, 59, 999);

                        // Vérifier s'il n'y a pas déjà un rendez-vous à cette date et heure
                        const existingAppointment = await db.collection('appointments')
                            .where('date', '==', this.appointmentForm.date)
                            .where('time', '==', this.appointmentForm.time)
                            .get();

                        if (!existingAppointment.empty) {
                            this.appointmentError = 'Ce créneau vient d\'être réservé par quelqu\'un d\'autre';
                            await this.loadUnavailableSlots();
                            return;
                        }

                        // Trouver le créneau correspondant dans timeSlots
                        const timeSlotSnapshot = await db.collection('timeSlots')
                            .where('date', '>=', firebase.firestore.Timestamp.fromDate(startOfDay))
                            .where('date', '<=', firebase.firestore.Timestamp.fromDate(endOfDay))
                            .where('time', '==', this.appointmentForm.time)
                            .get();

                        if (timeSlotSnapshot.empty) {
                            this.appointmentError = 'Ce créneau n\'est plus disponible';
                            await this.loadUnavailableSlots();
                            return;
                        }

                        const timeSlotId = timeSlotSnapshot.docs[0].id;

                        // Marquer le créneau comme indisponible
                        await db.collection('timeSlots')
                            .doc(timeSlotId)
                            .update({
                                unavailable: true,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });

                        // Créer le rendez-vous
                        const appointmentData = {
                            ...this.appointmentForm,
                            userId: firebase.auth().currentUser.uid,
                            userEmail: firebase.auth().currentUser.email,
                            timeSlotId: timeSlotId,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            status: 'confirmed'
                        };

                        // Si un animal existant est sélectionné, ajouter son ID et son temps de trajet
                        if (this.appointmentForm.selectedAnimalId) {
                            const selectedAnimal = this.animals.find(a => a.id === this.appointmentForm.selectedAnimalId);
                            appointmentData.animalId = this.appointmentForm.selectedAnimalId;
                            if (selectedAnimal && selectedAnimal.travelTime) {
                                appointmentData.travelTime = selectedAnimal.travelTime;
                            }
                        }

                        const appointmentRef = await db.collection('appointments').add(appointmentData);

                        // Si un animal existant est sélectionné, mettre à jour son historique
                        if (this.appointmentForm.selectedAnimalId) {
                            const animalRef = db.collection('animals').doc(this.appointmentForm.selectedAnimalId);
                            await animalRef.update({
                                appointments: firebase.firestore.FieldValue.arrayUnion({
                                    id: appointmentRef.id,
                                    date: this.appointmentForm.date,
                                    time: this.appointmentForm.time,
                                    notes: this.appointmentForm.notes || '',
                                    travelTime: appointmentData.travelTime || ''
                                })
                            });
                        }

                        // Envoyer une notification aux administrateurs
                        const formattedDate = new Date(this.appointmentForm.date).toLocaleDateString('fr-FR', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });

                        const notificationData = {
                            app_id: "c1dcb08f-cad7-4f3e-be08-b45671fbde82",
                            contents: {
                                en: `Nouveau rendez-vous pour ${this.appointmentForm.animalName} (${this.appointmentForm.animalType})`,
                                fr: `Nouveau rendez-vous pour ${this.appointmentForm.animalName} (${this.appointmentForm.animalType})`
                            },
                            headings: {
                                en: `${formattedDate} à ${this.appointmentForm.time}`,
                                fr: `${formattedDate} à ${this.appointmentForm.time}`
                            },
                            subtitle: {
                                en: `Contact: ${this.appointmentForm.phone}`,
                                fr: `Contact: ${this.appointmentForm.phone}`
                            },
                            url: window.location.origin + "/#admin",
                            // Envoyer uniquement aux administrateurs via les tags
                            filters: [
                                {"field": "tag", "key": "role", "relation": "=", "value": "admin"}
                            ],
                            // Ajouter des données personnalisées
                            data: {
                                type: "new_appointment",
                                appointmentId: appointmentRef.id,
                                animalName: this.appointmentForm.animalName,
                                animalType: this.appointmentForm.animalType,
                                date: this.appointmentForm.date,
                                time: this.appointmentForm.time,
                                phone: this.appointmentForm.phone
                            }
                        };

                        try {
                            // Envoyer la notification
                            const response = await fetch('https://onesignal.com/api/v1/notifications', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': 'Basic os_v2_app_yholbd6k25ht5pqiwrlhd666qi2l732wdaqepxupxqcpzmldkhlya27onu2hglbn2jqpeyjshfkn4g2nj6zks2o3skyegtdpvs7e3da'
                                },
                                body: JSON.stringify(notificationData)
                            });

                            if (!response.ok) {
                                console.error('OneSignal API error:', response.status, response.statusText);
                                const errorText = await response.text();
                                console.error('OneSignal error details:', errorText);
                            } else {
                                console.log('Notification de rendez-vous envoyée avec succès');
                            }
                        } catch (notificationError) {
                            console.error('Erreur lors de l\'envoi de la notification:', notificationError);
                            // Ne pas bloquer la création du rendez-vous si la notification échoue
                        }

                        // Réinitialiser le formulaire
                        this.appointmentForm = {
                            consultationType: '',
                            animalType: '',
                            animalName: '',
                            date: '',
                            time: '',
                            notes: '',
                            phone: '',
                            selectedAnimalId: ''
                        };
                        this.appointmentSuccess = true;
                        this.appointmentError = '';
                        
                        // Recharger les créneaux disponibles
                        await this.loadUnavailableSlots();
                    } catch (error) {
                        console.error('Error submitting appointment:', error);
                        this.appointmentError = 'Une erreur est survenue lors de la prise de rendez-vous. Veuillez réessayer.';
                    }
                },
                onAnimalSelected() {
                    if (this.appointmentForm.selectedAnimalId && this.appointmentForm.selectedAnimalId !== 'autre') {
                        const selectedAnimal = this.animals.find(a => a.id === this.appointmentForm.selectedAnimalId);
                        if (selectedAnimal) {
                            this.appointmentForm.animalName = selectedAnimal.name;
                            this.appointmentForm.animalType = selectedAnimal.species;
                        }
                    } else if (this.appointmentForm.selectedAnimalId === 'autre') {
                        // Réinitialiser les champs si "autre" est sélectionné
                        this.appointmentForm.animalName = '';
                        this.appointmentForm.animalType = '';
                    }
                },
                scrollToContact() {
                    const contactSection = document.getElementById('contact');
                    if (contactSection) {
                        contactSection.scrollIntoView({ behavior: 'smooth' });
                    }
                },
                navigateTo(page) {
                    this.closeMenu();
                    this.currentPage = page;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    if (page === 'admin' && this.isAdmin) {
                        this.loadAllData();
                    } else if (page === 'profile' && this.isAuthenticated) {
                        this.loadProfileData();
                    }
                },
                async loadAnimals() {
                    try {
                        // Nettoyer l'ancien écouteur s'il existe
                        if (this.unsubscribeAnimals) {
                            this.unsubscribeAnimals();
                            this.unsubscribeAnimals = null;
                        }

                        // Vérifier si l'utilisateur est connecté
                        const user = firebase.auth().currentUser;
                        if (!user) {
                            this.animals = [];
                            return;
                        }

                        const userId = user.uid;
                        console.log('Loading animals for user:', userId);

                        // Vérification de la connexion à Firestore
                        if (!db) {
                            throw new Error('Erreur de connexion à la base de données');
                        }

                        // Charger d'abord les informations de l'utilisateur
                        const userDoc = await db.collection('users').doc(userId).get();
                        if (userDoc.exists) {
                            this.userEmails[userId] = {
                                email: userDoc.data().email,
                                firstName: userDoc.data().firstName || '',
                                lastName: userDoc.data().lastName || '',
                                address: userDoc.data().address || '',
                                role: userDoc.data().role
                            };
                        }

                        // Utiliser onSnapshot pour les mises à jour en temps réel
                        this.unsubscribeAnimals = db.collection('animals')
                            .where('userId', '==', userId)
                            .orderBy('createdAt', 'desc')
                            .onSnapshot(
                                snapshot => {
                                    console.log('Animals updated:', snapshot.docs.length);
                                    this.animals = snapshot.docs.map(doc => ({
                                        id: doc.id,
                                        ...doc.data()
                                    }));
                                    console.log('Animals loaded:', this.animals);
                                },
                                error => {
                                    if (this.isAuthenticated) {
                                        console.error('Error in real-time update:', error);
                                        alert('Erreur lors de la mise à jour des animaux: ' + error.message);
                                    }
                                }
                            );
                    } catch (error) {
                        console.error('Error loading animals:', error);
                        this.animals = [];
                        if (this.isAuthenticated) {
                            alert('Erreur lors du chargement des animaux: ' + error.message);
                        }
                    }
                },
                async addAnimal() {
                    if (!this.newAnimal.name || !this.newAnimal.species || !this.newAnimal.birthdate) {
                        alert('Veuillez remplir tous les champs obligatoires');
                        return;
                    }

                    // Vérifier si un propriétaire est sélectionné (pour l'admin)
                    if (this.isAdmin && !this.newAnimal.userId) {
                        alert('Veuillez sélectionner un propriétaire');
                        return;
                    }

                    try {
                        console.log('Début de l\'ajout de l\'animal');
                        console.log('Documents à ajouter:', this.newAnimal.documents);

                        const animalData = {
                        name: this.newAnimal.name,
                            species: this.newAnimal.species,
                            race: this.newAnimal.race || '',
                            birthdate: this.newAnimal.birthdate,
                            sterilization: this.newAnimal.sterilization || false,
                            sterilizationDetails: this.newAnimal.sterilizationDetails || '',
                            diet: this.newAnimal.diet || '',
                            activity: this.newAnimal.activity || '',
                            activityDetails: this.newAnimal.activityDetails || '',
                            medicalHistory: this.newAnimal.medicalHistory || '',
                            treatment: this.newAnimal.treatment || '',
                            behavior: this.newAnimal.behavior || '',
                        notes: this.newAnimal.notes || '',
                            travelTime: this.newAnimal.travelTime || '',
                            // Utiliser l'ID du client sélectionné si on est admin, sinon l'ID de l'utilisateur connecté
                            userId: this.isAdmin ? this.newAnimal.userId : firebase.auth().currentUser.uid,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                            documents: this.newAnimal.documents || []
                        };

                    if (this.newAnimal.photosBase64 && this.newAnimal.photosBase64.length > 0) {
                        animalData.photos = this.newAnimal.photosBase64;
                    }

                        console.log('Envoi à Firestore...');

                        await firebase.firestore().collection('animals').add(animalData);
                        console.log('Animal ajouté avec succès');
                        
                        // Réinitialiser le formulaire
                            this.showAddAnimalModal = false;
                        this.newAnimal = {
                            name: '',
                            species: '',
                            race: '',
                            birthdate: '',
                            sterilization: false,
                            sterilizationDetails: '',
                            diet: '',
                            activity: '',
                            activityDetails: '',
                            medicalHistory: '',
                            treatment: '',
                            behavior: '',
                                notes: '',
                            photosPreview: [],
                            photosBase64: [],
                            documents: [],
                            userId: '' // Ajout du champ userId
                            };

                        alert('Animal ajouté avec succès !');
                    } catch (error) {
                        console.error('Erreur détaillée lors de l\'ajout de l\'animal:', error);
                        alert('Une erreur est survenue lors de l\'ajout de l\'animal: ' + error.message);
                    }
                },
                formatDate(date) {
                    if (!date) return 'N/A';
                    if (date instanceof firebase.firestore.Timestamp) {
                        date = date.toDate();
                    }
                    const options = { year: 'numeric', month: 'long', day: 'numeric' };
                    return new Date(date).toLocaleDateString('fr-FR', options);
                },
                formatDateFr(dateString) {
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    return new Date(dateString).toLocaleDateString('fr-FR', options);
                },
                viewAnimalDetails(animal) {
                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.innerHTML = `
                        <div class="modal-content" id="animal-details-modal">
                            <h2>Détails de ${animal.name}</h2>
                            <div class="animal-details-row">
                                <div class="animal-profile-pic">
                                    ${animal.photos && animal.photos.length > 0 
                                        ? `<div class="animal-photos-grid">
                                            ${animal.photos.map((photo, index) => `
                                                <div class="animal-photo-item">
                                                    <img src="${photo}" alt="${animal.name} - Photo ${index + 1}" class="animal-photo" onclick="this.dispatchEvent(new CustomEvent('view-photo', {detail: {photo: '${photo}', index: ${index}, total: ${animal.photos.length}}, bubbles: true}))">
                                                </div>
                                            `).join('')}
                                           </div>`
                                        : animal.photoBase64 
                                            ? `<img src="${animal.photoBase64}" alt="${animal.name}" class="animal-photo" id="animal-photo-preview">`
                                            : '<div class="animal-photo placeholder"><span>Pas de photo</span></div>'
                                    }
                                </div>
                                <div class="animal-basic-info-right">
                                    <p><strong>Espèce :</strong> <span id="animal-species">${animal.species}</span></p>
                                    <p><strong>Race :</strong> <span id="animal-race">${animal.race || 'Non renseignée'}</span></p>
                                    <p><strong>Date de naissance :</strong> <span id="animal-birthdate">${this.formatDate(animal.birthdate)}</span></p>
                                    <p><strong>Stérilisation :</strong> <span id="animal-sterilization">${animal.sterilization ? 'Oui' : 'Non'}</span></p>
                                    ${animal.sterilization && animal.sterilizationDetails ? `<p><strong>Détails de la stérilisation :</strong> <span id="animal-sterilization-details">${animal.sterilizationDetails}</span></p>` : ''}
                                </div>
                            </div>
                            <div class="animal-details-section">
                                <h3>Informations du propriétaire</h3>
                                <div class="details-grid">
                                    <div class="detail-item">
                                        <h4>Propriétaire</h4>
                                        <p>${this.getUserFullName(animal.userId)}</p>
                                    </div>
                                    <div class="detail-item">
                                        <h4>Adresse</h4>
                                        <p>${this.userEmails[animal.userId]?.address || 'Non renseignée'}</p>
                                    </div>
                                    <div class="detail-item">
                                        <h4>Temps de trajet</h4>
                                        <p>${animal.travelTime || 'Non renseigné'}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="animal-details-section">
                                <h3>Informations générales</h3>
                                <div class="details-grid">
                                    <div class="detail-item">
                                        <h4>Alimentation</h4>
                                        <p>${animal.diet || 'Non renseignée'}</p>
                                    </div>
                                    <div class="detail-item">
                                        <h4>Activité</h4>
                                        <p>${animal.activity || 'Non renseignée'}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="animal-details-section">
                                <h3>Informations médicales</h3>
                                <div class="details-grid">
                                    <div class="detail-item">
                                        <h4>Antécédents médicaux</h4>
                                        <p>${animal.medicalHistory || 'Aucun antécédent renseigné'}</p>
                                    </div>
                                    <div class="detail-item">
                                        <h4>Traitement en cours</h4>
                                        <p>${animal.treatment || 'Aucun traitement en cours'}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="animal-details-section">
                                <h3>Comportement</h3>
                                <p>${animal.behavior || 'Aucune particularité comportementale renseignée'}</p>
                            </div>
                            <div class="animal-details-section">
                                <h3>Notes supplémentaires</h3>
                                <p>${animal.notes || 'Aucune note supplémentaire'}</p>
                            </div>
                            <div class="body-map-container">
                                <h3>Plan du corps</h3>
                                <div class="body-map" id="bodyMap-${animal.id}">
                                    <img src="images/body_map_${animal.species}.svg" alt="Plan du corps ${animal.species}" style="width: 100%; height: 100%; object-fit: contain;">
                                </div>
                                <div class="body-map-annotations-list" id="annotations-list-${animal.id}">
                                  <h4>Annotations du plan du corps :</h4>
                                  <ul></ul>
                                </div>
                                <button class="btn btn-add-annotation">
                                    Ajouter une annotation
                                </button>
                            </div>
                            <div class="animal-details-section">
                                <h3>Documents</h3>
                                <div class="documents-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                                    ${animal.documents && animal.documents.length > 0 
                                        ? animal.documents.map(doc => `
                                            <div class="document-card" style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); cursor: pointer;" onclick="this.dispatchEvent(new CustomEvent('view-document', {detail: '${doc.id}', bubbles: true}))">
                                                <img src="${doc.data}" alt="${doc.name}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 4px; margin-bottom: 0.5rem;">
                                                <p style="font-size: 0.9rem; color: var(--text-color); margin: 0;">${doc.name}</p>
                                                <p style="font-size: 0.8rem; color: var(--secondary-color); margin: 0.2rem 0 0 0;">${this.formatDate(doc.date)}</p>
                                            </div>
                                        `).join('')
                                        : '<p>Aucun document</p>'
                                    }
                                </div>
                            </div>
                            <div class="appointments-history">
                                <h3>Historique des rendez-vous</h3>
                                <div class="appointments-list">
                                    ${animal.appointments && animal.appointments.length > 0 
                                        ? animal.appointments.map(apt => `
                                            <div class="appointment-item">
                                                <p>${this.formatDateFr(apt.date)} - ${apt.time}</p>
                                                ${apt.travelTime ? `<p><strong>Temps de trajet :</strong> ${apt.travelTime}</p>` : ''}
                                                ${apt.notes ? `<p><strong>Notes :</strong> ${apt.notes}</p>` : ''}
                                            </div>
                                        `).join('')
                                        : '<p>Aucun rendez-vous enregistré</p>'
                                    }
                                </div>
                            </div>
                            <div class="modal-actions">
                                <button class="btn" id="edit-animal-btn">Modifier</button>
                                <button class="btn secondary" id="close-animal-modal">Fermer</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);

                    // Ajouter le gestionnaire pour l'affichage en grand format
                    modal.addEventListener('view-document', (e) => {
                        const documentId = e.detail;
                        const selectedDoc = animal.documents.find(doc => doc.id === documentId);
                        if (selectedDoc) {
                            const fullscreenModal = window.document.createElement('div');
                            fullscreenModal.className = 'modal';
                            fullscreenModal.style.cssText = 'z-index: 1001; display: flex; align-items: flex-start; justify-content: center; padding: 100px 20px 20px 20px; overflow-y: auto;';
                            fullscreenModal.innerHTML = `
                                <div class="modal-content" style="max-width: 90vw; max-height: calc(100vh - 140px); overflow-y: auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); padding: 1.5rem; position: relative;">
                                    <div style="position: relative;">
                                        <div style="display: flex; justify-content: center; min-height: 200px; max-height: calc(90vh - 100px); overflow-y: auto;">
                                            <img src="${selectedDoc.data}" alt="${selectedDoc.name}" style="width: auto; max-width: 100%; height: auto; object-fit: contain;">
                                        </div>
                                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                                            <h3 style="margin: 0; color: var(--primary-color);">${selectedDoc.name}</h3>
                                            <p style="margin: 0.5rem 0 0 0; color: var(--secondary-color);">Ajouté le ${this.formatDate(selectedDoc.date)}</p>
                                        </div>
                                        <button class="btn secondary" style="position: absolute; top: -10px; right: -10px; border-radius: 50%; width: 30px; height: 30px; padding: 0; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2);" onclick="this.closest('.modal').remove()">×</button>
                                    </div>
                                </div>
                            `;
                            window.document.body.appendChild(fullscreenModal);

                            // Ajouter un gestionnaire pour fermer avec la touche Echap
                            const handleEscape = (event) => {
                                if (event.key === 'Escape') {
                                    fullscreenModal.remove();
                                    window.removeEventListener('keydown', handleEscape);
                                }
                            };
                            window.addEventListener('keydown', handleEscape);

                            // Fermer en cliquant en dehors de l'image
                            fullscreenModal.addEventListener('click', (event) => {
                                if (event.target === fullscreenModal) {
                                    fullscreenModal.remove();
                                    window.removeEventListener('keydown', handleEscape);
                                }
                            });
                        }
                    });

                    // Gestion des événements de photos
                    modal.addEventListener('view-photo', (e) => {
                        const { photo, index, total } = e.detail;
                        const fullscreenModal = window.document.createElement('div');
                        fullscreenModal.className = 'modal';
                        fullscreenModal.style.cssText = 'z-index: 1001; display: flex; align-items: center; justify-content: center; padding: 20px; background: rgba(0,0,0,0.9);';
                        fullscreenModal.innerHTML = `
                            <div class="modal-content" style="max-width: 90vw; max-height: 90vh; background: transparent; box-shadow: none; padding: 0; position: relative;">
                                <button onclick="this.closest('.modal').remove()" style="position: absolute; top: -40px; right: 0; background: #ff4444; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;">×</button>
                                <img src="${photo}" alt="Photo ${index + 1} de ${total}" style="width: 100%; height: auto; max-height: 90vh; object-fit: contain; border-radius: 8px;">
                                <div style="position: absolute; bottom: -30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px;">
                                    Photo ${index + 1} sur ${total}
                                </div>
                            </div>
                        `;
                        document.body.appendChild(fullscreenModal);

                        // Ajouter un gestionnaire pour fermer avec la touche Echap
                        const handleEscape = (event) => {
                            if (event.key === 'Escape') {
                                fullscreenModal.remove();
                                window.removeEventListener('keydown', handleEscape);
                            }
                        };
                        window.addEventListener('keydown', handleEscape);

                        // Fermer en cliquant en dehors de l'image
                        fullscreenModal.addEventListener('click', (event) => {
                            if (event.target === fullscreenModal) {
                                fullscreenModal.remove();
                                window.removeEventListener('keydown', handleEscape);
                            }
                        });
                    });

                    // Ajout de la logique d'édition
                    document.getElementById('edit-animal-btn').onclick = () => {
                        this.showEditAnimalForm(animal, modal);
                    };

                    // Ajout de la logique pour l'annotation
                    modal.querySelector('.btn-add-annotation').onclick = () => {
                        this.addBodyAnnotation(animal.id);
                    };

                    // Afficher les annotations après que le DOM du body map est prêt
                    setTimeout(() => {
                        this.displayBodyAnnotations(animal.id);
                    }, 0);

                    // Gestion fermeture (Échap et retour)
                    const closeModal = () => {
                        modal.remove();
                        window.removeEventListener('keydown', escListener);
                        window.removeEventListener('popstate', popListener);
                        // Ne gérer l'historique que si on n'est pas dans l'interface d'administration
                        if (window.location.hash === '#animaldetails' && this.currentPage !== 'admin') {
                            history.back();
                        }
                    };
                    const escListener = (e) => {
                        if (e.key === 'Escape') {
                            closeModal();
                        }
                    };
                    window.addEventListener('keydown', escListener);
                    const popListener = (e) => {
                        closeModal();
                    };
                    window.addEventListener('popstate', popListener);
                    // N'ajouter une entrée à l'historique que si on n'est pas dans l'interface d'administration
                    if (this.currentPage !== 'admin') {
                        history.pushState({ animalModal: true }, '', '#animaldetails');
                    }
                    modal.querySelector('#close-animal-modal').onclick = closeModal;
                },
                showEditAnimalForm(animal, modal) {
                    // Remplacer le contenu de la modal par un formulaire d'édition
                    modal.querySelector('.modal-content').innerHTML = `
                        <h2>Modifier ${animal.name}</h2>
                        <form id="edit-animal-form">
                            <div class="animal-details-row">
                                <div class="animal-profile-pic">
                                    <div class="photos-grid">
                                        ${animal.photos && animal.photos.length > 0 
                                            ? animal.photos.map((photo, index) => `
                                                <div class="photo-item">
                                                    <img src="${photo}" alt="${animal.name}" class="animal-photo">
                                                    <button type="button" class="btn-remove-photo" data-index="${index}">×</button>
                                                </div>
                                            `).join('')
                                            : '<p>Aucune photo</p>'
                                        }
                                    </div>
                                    <input type="file" id="edit-animal-photos" accept="image/*" multiple style="margin-top:1rem;">
                                    <small style="color: var(--text-color); font-size: 0.8rem;">Format recommandé : JPG, PNG (max 5MB par image, max 10 images)</small>
                                </div>
                                <div class="animal-basic-info-right">
                                    <label>Nom :</label>
                                    <input type="text" id="edit-animal-name" value="${animal.name}" required>
                                    
                                    <label>Espèce :</label>
                                    <select id="edit-animal-species" required>
                                        <option value="chien" ${animal.species === 'chien' ? 'selected' : ''}>Chien</option>
                                        <option value="chat" ${animal.species === 'chat' ? 'selected' : ''}>Chat</option>
                                        <option value="cheval" ${animal.species === 'cheval' ? 'selected' : ''}>Cheval</option>
                                        <option value="autre" ${animal.species === 'autre' ? 'selected' : ''}>Autre</option>
                                    </select>

                                    <label>Race :</label>
                                    <input type="text" id="edit-animal-race" value="${animal.race || ''}">
                                    
                                    <label>Date de naissance :</label>
                                    <input type="date" id="edit-animal-birthdate" value="${animal.birthdate}" required>

                                    <div style="display: flex; align-items: center; gap: 1rem; margin-top: 1rem;">
                                        <label style="margin-bottom: 0;">Stérilisation :</label>
                                        <div class="radio-group" style="display: flex; gap: 1.5rem;">
                                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="radio" name="sterilization" value="true" ${animal.sterilization ? 'checked' : ''}>
                                                Oui
                                            </label>
                                            <label style="display: flex; align-items: center; gap: 0.5rem;">
                                                <input type="radio" name="sterilization" value="false" ${!animal.sterilization ? 'checked' : ''}>
                                                Non
                                            </label>
                                </div>
                            </div>
                                </div>
                            </div>
                            <div class="form-group" id="sterilization-details-group" style="display: ${animal.sterilization ? 'block' : 'none'};">
                                <label>Détails de la stérilisation :</label>
                                <textarea id="edit-animal-sterilization-details" rows="2" placeholder="Date de stérilisation, type d'intervention, vétérinaire, etc.">${animal.sterilizationDetails || ''}</textarea>
                            </div>

                            <div class="form-group">
                                <label>Alimentation :</label>
                                <textarea id="edit-animal-diet" rows="2" placeholder="Type d'alimentation, fréquence des repas, etc.">${animal.diet || ''}</textarea>
                            </div>

                            <div class="form-group">
                                <label>Activité :</label>
                                <select id="edit-animal-activity" required>
                                    <option value="">Sélectionnez le niveau d'activité</option>
                                    <option value="sédentaire" ${animal.activity === 'sédentaire' ? 'selected' : ''}>Sédentaire (très peu d'activité)</option>
                                    <option value="peu_actif" ${animal.activity === 'peu_actif' ? 'selected' : ''}>Peu actif (activité occasionnelle)</option>
                                    <option value="actif" ${animal.activity === 'actif' ? 'selected' : ''}>Actif (activité régulière)</option>
                                    <option value="très_actif" ${animal.activity === 'très_actif' ? 'selected' : ''}>Très actif (activité intense et fréquente)</option>
                                    <option value="sportif" ${animal.activity === 'sportif' ? 'selected' : ''}>Sportif/Compétition</option>
                                </select>
                                <textarea id="edit-animal-activity-details" rows="2" placeholder="Détails sur le type d'activité (promenades, sport, etc.)">${animal.activityDetails || ''}</textarea>
                            </div>

                            <div class="form-group">
                                <label>Antécédents médicaux :</label>
                                <textarea id="edit-animal-medical-history" rows="3" placeholder="Maladies, opérations, blessures passées, etc.">${animal.medicalHistory || ''}</textarea>
                            </div>

                            <div class="form-group">
                                <label>Traitement en cours :</label>
                                <textarea id="edit-animal-treatment" rows="2" placeholder="Médicaments, posologie, durée, etc.">${animal.treatment || ''}</textarea>
                            </div>

                            <div class="form-group">
                                <label>Temps de trajet :</label>
                                <input type="text" id="edit-animal-travel-time" value="${animal.travelTime || ''}" placeholder="Ex: 30 minutes">
                            </div>

                            <div class="form-group">
                                <label>Particularités comportementales :</label>
                                <textarea id="edit-animal-behavior" rows="2" placeholder="Comportements particuliers, anxiété, agressivité, etc."></textarea>
                            </div>

                            <div class="form-group">
                                <label>Notes supplémentaires :</label>
                                <textarea id="edit-animal-notes" rows="3">${animal.notes || ''}</textarea>
                            </div>

                            <div class="form-group">
                                <label>Documents :</label>
                                <div class="documents-grid">
                                    ${animal.documents && animal.documents.length > 0 
                                        ? animal.documents.map(doc => `
                                            <div class="document-card">
                                                <img src="${doc.data}" alt="${doc.name}">
                                                <p>${doc.name}</p>
                                                <p>${this.formatDate(doc.date)}</p>
                                                <button type="button" class="btn-delete" onclick="this.closest('.document-card').dispatchEvent(new CustomEvent('delete-document', {detail: '${doc.id}', bubbles: true}))">
                                                    Supprimer
                                                </button>
                                            </div>
                                        `).join('')
                                        : '<p>Aucun document</p>'
                                    }
                                </div>
                                <input type="file" id="edit-animal-documents" accept="image/*" multiple style="margin-top: 1rem;">
                                <small style="color: var(--text-color); font-size: 0.8rem;">Formats acceptés : JPG, PNG</small>
                            </div>

                            <div class="modal-actions">
                                <button type="submit" class="btn primary">Enregistrer</button>
                                <button type="button" class="btn secondary" id="cancel-edit-animal">Annuler</button>
                            </div>
                        </form>
                    `;

                    // Gestion des photos multiples
                    const photosInput = modal.querySelector('#edit-animal-photos');
                    let currentPhotos = animal.photos || [];
                    
                    // Initialiser les gestionnaires d'événements pour les boutons de suppression existants
                    const initialRemoveButtons = modal.querySelectorAll('.btn-remove-photo');
                    initialRemoveButtons.forEach(button => {
                        button.addEventListener('click', (e) => {
                            e.preventDefault();
                            const index = parseInt(button.getAttribute('data-index'));
                            currentPhotos.splice(index, 1);
                            this.updatePhotosDisplay(modal, currentPhotos);
                        });
                    });
                    
                    // Gestionnaire pour la suppression de photos (pour les nouvelles photos ajoutées)
                    modal.addEventListener('delete-photo', (e) => {
                        const index = e.detail;
                        currentPhotos.splice(index, 1);
                        // Mettre à jour l'affichage
                        this.updatePhotosDisplay(modal, currentPhotos);
                    });
                    
                    photosInput.addEventListener('change', (e) => {
                        const files = Array.from(e.target.files);
                        if (files.length === 0) return;

                        if (files.length > 10) {
                            alert('Vous ne pouvez pas sélectionner plus de 10 images à la fois.');
                            e.target.value = '';
                            return;
                        }

                        files.forEach(file => {
                            if (!file.type.startsWith('image/')) {
                                alert(`Le fichier ${file.name} doit être une image`);
                                return;
                            }

                            try {
                                // Créer un aperçu de l'image
                                const reader = new FileReader();
                                reader.onload = async (ev) => {
                                    // Créer une image pour le redimensionnement
                                    const img = new Image();
                                    img.onload = async () => {
                                        // Créer un canvas pour le redimensionnement
                                        const canvas = document.createElement('canvas');
                                        let width = img.width;
                                        let height = img.height;
                                        
                                        // Calculer les nouvelles dimensions en gardant le ratio
                                        const MAX_WIDTH = 800;
                                        const MAX_HEIGHT = 800;
                                        
                                        if (width > height) {
                                            if (width > MAX_WIDTH) {
                                                height *= MAX_WIDTH / width;
                                                width = MAX_WIDTH;
                                            }
                                        } else {
                                            if (height > MAX_HEIGHT) {
                                                width *= MAX_HEIGHT / height;
                                                height = MAX_HEIGHT;
                                            }
                                        }
                                        
                                        canvas.width = width;
                                        canvas.height = height;
                                        
                                        // Dessiner l'image redimensionnée
                                        const ctx = canvas.getContext('2d');
                                        ctx.drawImage(img, 0, 0, width, height);
                                        
                                        // Convertir en base64 avec compression
                                        const resizedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                                        
                                        // Vérifier la taille finale
                                        const base64Size = resizedBase64.length * 3 / 4;
                                        if (base64Size > 900000) { // ~900KB pour avoir une marge
                                            alert(`L'image ${file.name} est trop grande même après compression. Veuillez choisir une image plus petite.`);
                                            return;
                                        }
                                        
                                        // Ajouter à la liste des photos
                                        currentPhotos.push(resizedBase64);
                                        this.updatePhotosDisplay(modal, currentPhotos);
                                    };
                                    img.src = ev.target.result;
                                };
                                reader.readAsDataURL(file);
                            } catch (error) {
                                console.error('Erreur lors du traitement de l\'image:', error);
                                alert(`Erreur lors du traitement de l'image ${file.name}. Veuillez réessayer avec une autre image.`);
                            }
                        });
                    });

                    // Annuler l'édition
                    modal.querySelector('#cancel-edit-animal').onclick = () => {
                        this.viewAnimalDetails(animal);
                        modal.remove();
                    };

                    // Gestion de l'affichage du champ détails de stérilisation
                    const sterilizationRadios = modal.querySelectorAll('input[name="sterilization"]');
                    const sterilizationDetailsGroup = modal.querySelector('#sterilization-details-group');
                    
                    sterilizationRadios.forEach(radio => {
                        radio.addEventListener('change', () => {
                            sterilizationDetailsGroup.style.display = radio.value === 'true' ? 'block' : 'none';
                        });
                    });

                    // Soumission du formulaire
                    modal.querySelector('#edit-animal-form').onsubmit = async (e) => {
                        e.preventDefault();
                        const updatedAnimal = {
                            name: modal.querySelector('#edit-animal-name').value,
                            species: modal.querySelector('#edit-animal-species').value,
                            race: modal.querySelector('#edit-animal-race').value,
                            birthdate: modal.querySelector('#edit-animal-birthdate').value,
                            sterilization: modal.querySelector('input[name="sterilization"]:checked').value === 'true',
                            sterilizationDetails: modal.querySelector('#edit-animal-sterilization-details').value,
                            diet: modal.querySelector('#edit-animal-diet').value,
                            activity: modal.querySelector('#edit-animal-activity').value,
                            activityDetails: modal.querySelector('#edit-animal-activity-details').value,
                            medicalHistory: modal.querySelector('#edit-animal-medical-history').value,
                            treatment: modal.querySelector('#edit-animal-treatment').value,
                            behavior: modal.querySelector('#edit-animal-behavior').value,
                            notes: modal.querySelector('#edit-animal-notes').value,
                            travelTime: modal.querySelector('#edit-animal-travel-time').value,
                            photos: currentPhotos,
                            documents: currentDocuments,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        try {
                            await firebase.firestore().collection('animals').doc(animal.id).update(updatedAnimal);
                            alert('Modifications enregistrées !');
                            modal.remove();
                            this.loadAnimals();
                        } catch (err) {
                            console.error('Erreur lors de la sauvegarde:', err);
                            alert('Erreur lors de la sauvegarde : ' + err.message);
                        }
                    };

                    // Gestion des documents
                    const documentsInput = modal.querySelector('#edit-animal-documents');
                    let currentDocuments = animal.documents || [];
                    
                    documentsInput.addEventListener('change', async (e) => {
                        const files = Array.from(e.target.files);
                        if (files.length === 0) return;

                        for (const file of files) {
                            try {
                                // Vérifier le type de fichier
                                if (!file.type.startsWith('image/')) {
                                    alert(`Le fichier ${file.name} doit être une image`);
                                    continue;
                                }

                                // Créer un aperçu de l'image
                                const reader = new FileReader();
                                reader.onload = async (e) => {
                                    // Créer une image pour le redimensionnement
                                    const img = new Image();
                                    img.onload = async () => {
                                        // Créer un canvas pour le redimensionnement
                                        const canvas = document.createElement('canvas');
                                        let width = img.width;
                                        let height = img.height;
                                        
                                        // Calculer les nouvelles dimensions en gardant le ratio
                                        const MAX_WIDTH = 1200;
                                        const MAX_HEIGHT = 1200;
                                        
                                        if (width > height) {
                                            if (width > MAX_WIDTH) {
                                                height *= MAX_WIDTH / width;
                                                width = MAX_WIDTH;
                                            }
                                        } else {
                                            if (height > MAX_HEIGHT) {
                                                width *= MAX_HEIGHT / height;
                                                height = MAX_HEIGHT;
                                            }
                                        }
                                        
                                        canvas.width = width;
                                        canvas.height = height;
                                        
                                        // Dessiner l'image redimensionnée
                                        const ctx = canvas.getContext('2d');
                                        ctx.drawImage(img, 0, 0, width, height);
                                        
                                        // Convertir en base64 avec compression adaptée
                                        const resizedBase64 = canvas.toDataURL('image/jpeg', 0.8);
                                        
                                        // Créer un nouvel objet document
                                        const newDocument = {
                                            id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                                            name: file.name,
                                            date: new Date().toISOString(),
                                            data: resizedBase64
                                        };

                                        // Ajouter le document à la liste
                                        currentDocuments.push(newDocument);

                                        // Mettre à jour l'affichage
                                        const documentsGrid = modal.querySelector('.documents-grid');
                                        documentsGrid.innerHTML = currentDocuments.map(doc => `
                                            <div class="document-card">
                                                <img src="${doc.data}" alt="${doc.name}">
                                                <p>${doc.name}</p>
                                                <p>${this.formatDate(doc.date)}</p>
                                                <button type="button" class="btn-delete" onclick="this.closest('.document-card').dispatchEvent(new CustomEvent('delete-document', {detail: '${doc.id}', bubbles: true}))">
                                                    Supprimer
                                                </button>
                                            </div>
                                        `).join('');
                                    };
                                    img.src = e.target.result;
                                };
                                reader.readAsDataURL(file);
                            } catch (error) {
                                console.error('Erreur lors du traitement du document:', error);
                                alert(`Erreur lors du traitement du document ${file.name}. Veuillez réessayer.`);
                            }
                        }
                        
                        // Réinitialiser l'input
                        e.target.value = '';
                    });

                    // Gestion de la suppression des documents
                    modal.addEventListener('delete-document', async (e) => {
                        const documentId = e.detail;
                        try {
                            // Filtrer les documents pour retirer celui qu'on veut supprimer
                            currentDocuments = currentDocuments.filter(doc => doc.id !== documentId);
                            
                            // Mettre à jour l'affichage
                            const documentsGrid = modal.querySelector('.documents-grid');
                            if (currentDocuments.length > 0) {
                                documentsGrid.innerHTML = currentDocuments.map(doc => `
                                    <div class="document-card">
                                        <img src="${doc.data}" alt="${doc.name}">
                                        <p>${doc.name}</p>
                                        <p>${this.formatDate(doc.date)}</p>
                                        <button type="button" class="btn-delete" onclick="this.closest('.document-card').dispatchEvent(new CustomEvent('delete-document', {detail: '${doc.id}', bubbles: true}))">
                                            Supprimer
                                        </button>
                                    </div>
                                `).join('');
                            } else {
                                documentsGrid.innerHTML = '<p>Aucun document</p>';
                            }
                        } catch (error) {
                            console.error('Erreur lors de la suppression du document:', error);
                            alert('Erreur lors de la suppression du document. Veuillez réessayer.');
                        }
                    });
                },
                async checkAdminStatus() {
                    if (!firebase.auth().currentUser) {
                        this.isAdmin = false;
                        // Cacher le bouton de notification
                        const bellContainer = document.querySelector('#onesignal-bell-container');
                        if (bellContainer) {
                            bellContainer.classList.remove('show-bell');
                        }
                        return;
                    }
                    try {
                        const userDoc = await db.collection('users')
                            .doc(firebase.auth().currentUser.uid)
                            .get();
                        this.isAdmin = userDoc.exists && userDoc.data().role === 'admin';
                        
                        // Initialiser OneSignal uniquement si ce n'est pas déjà fait
                        if (this.isAdmin) {
                            if (!window.OneSignal.initialized) {
                                window.OneSignal.push(function() {
                                    OneSignal.init({
                                        appId: "c1dcb08f-cad7-4f3e-be08-b45671fbde82",
                                        safari_web_id: "web.onesignal.auto.xxx",
                                        // Configuration améliorée pour la compatibilité
                                        allowLocalhostAsSecureOrigin: true,
                                        autoRegister: true,
                                        autoResubscribe: true,
                                        persistNotification: true,
                                        // Utiliser le service worker par défaut d'OneSignal
                                        // Configuration des notifications
                                        notifyButton: {
                                            enable: true,
                                            size: 'medium',
                                            theme: 'default',
                                            position: 'bottom-right',
                                            offset: {
                                                bottom: '20px',
                                                right: '20px'
                                            },
                                            prenotify: true,
                                            showCredit: false,
                                            text: {
                                                'tip.state.unsubscribed': 'Activer les notifications administrateur',
                                                'tip.state.subscribed': 'Notifications administrateur activées',
                                                'tip.state.blocked': 'Notifications administrateur bloquées',
                                                'message.prenotify': 'Cliquez pour activer les notifications administrateur',
                                                'message.action.subscribed': 'Merci ! Vous recevrez les notifications administrateur',
                                                'message.action.resubscribed': 'Notifications administrateur réactivées',
                                                'message.action.unsubscribed': 'Notifications administrateur désactivées',
                                                'dialog.main.title': 'Notifications Administrateur',
                                                'dialog.main.button.subscribe': 'ACTIVER',
                                                'dialog.main.button.unsubscribe': 'DÉSACTIVER',
                                                'dialog.blocked.title': 'Débloquer les notifications',
                                                'dialog.blocked.message': 'Suivez ces instructions pour autoriser les notifications:'
                                            }
                                        },
                                        // Configuration des prompts
                                        promptOptions: {
                                            slidedown: {
                                                prompts: [
                                                    {
                                                        type: "push",
                                                        autoPrompt: true,
                                                        text: {
                                                            actionMessage: "Voulez-vous recevoir les notifications administrateur ?",
                                                            acceptButton: "Autoriser",
                                                            cancelButton: "Plus tard"
                                                        }
                                                    }
                                                ]
                                            }
                                        },
                                        // Configuration pour les anciens navigateurs
                                        welcomeNotification: {
                                            disable: false,
                                            title: "Notifications activées !",
                                            message: "Vous recevrez maintenant les notifications administrateur"
                                        },
                                        // Configuration des permissions
                                        permissionDialog: {
                                            enable: true,
                                            title: "Notifications Emmy Vasse",
                                            message: "Recevez les notifications importantes de votre activité d'ostéopathe animalier",
                                            acceptButtonText: "Autoriser",
                                            cancelButtonText: "Plus tard"
                                        }
                                    });
                                    
                                    // Attendre que OneSignal soit prêt
                                    OneSignal.on('subscriptionChange', function(isSubscribed) {
                                        console.log('OneSignal subscription changed:', isSubscribed);
                                    });
                                    
                                    OneSignal.on('notificationPermissionChange', function(permission) {
                                        console.log('OneSignal permission changed:', permission);
                                    });
                                    
                                    // Afficher le prompt après un délai
                                    setTimeout(() => {
                                        OneSignal.showSlidedownPrompt();
                                    }, 2000);
                                    
                                    // Tagger l'utilisateur si c'est un admin
                                    if (this.isAdmin) {
                                        OneSignal.push(function() {
                                            OneSignal.sendTag('role', 'admin');
                                            console.log('Utilisateur tagué comme admin');
                                            
                                            // Vérifier les tags après 2 secondes
                                            setTimeout(() => {
                                                OneSignal.getTags().then(tags => {
                                                    console.log('Tags actuels:', tags);
                                                });
                                            }, 2000);
                                        });
                                    } else {
                                        // Tagger les utilisateurs non-admin avec 'user'
                                        OneSignal.push(function() {
                                            OneSignal.sendTag('role', 'user');
                                            console.log('Utilisateur tagué comme user');
                                            
                                            // Vérifier les tags après 2 secondes
                                            setTimeout(() => {
                                                OneSignal.getTags().then(tags => {
                                                    console.log('Tags actuels:', tags);
                                                });
                                            }, 2000);
                                        });
                                    }
                                    
                                    window.OneSignal.initialized = true;
                                });
                                

                                
                                // Fonction pour envoyer une notification à des appareils spécifiques
                                window.sendNotificationToSpecificDevices = async function(deviceIds, title, message, url = null) {
                                    const notificationData = {
                                        app_id: "c1dcb08f-cad7-4f3e-be08-b45671fbde82",
                                        contents: {
                                            en: message,
                                            fr: message
                                        },
                                        headings: {
                                            en: title,
                                            fr: title
                                        },
                                        include_player_ids: deviceIds,
                                        data: {
                                            type: "custom_notification",
                                            customUrl: url
                                        }
                                    };

                                    if (url) {
                                        notificationData.url = url;
                                    }

                                    try {
                                        const response = await fetch('https://onesignal.com/api/v1/notifications', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json',
                                                'Authorization': 'Basic os_v2_app_yholbd6k25ht5pqiwrlhd666qi2l732wdaqepxupxqcpzmldkhlya27onu2hglbn2jqpeyjshfkn4g2nj6zks2o3skyegtdpvs7e3da'
                                            },
                                            body: JSON.stringify(notificationData)
                                        });

                                        if (!response.ok) {
                                            console.error('OneSignal API error:', response.status, response.statusText);
                                            const errorText = await response.text();
                                            console.error('OneSignal error details:', errorText);
                                        } else {
                                            console.log('Notification envoyée aux appareils spécifiés');
                                        }
                                    } catch (error) {
                                        console.error('Erreur lors de l\'envoi de la notification:', error);
                                    }
                                };
                            }
                            // Afficher le bouton de notification
                            setTimeout(() => {
                                const bellContainer = document.querySelector('#onesignal-bell-container');
                                if (bellContainer) {
                                    bellContainer.classList.add('show-bell');
                                }
                            }, 1000);
                        } else {
                            // Cacher le bouton de notification pour les non-admins
                            const bellContainer = document.querySelector('#onesignal-bell-container');
                            if (bellContainer) {
                                bellContainer.classList.remove('show-bell');
                            }
                        }
                    } catch (error) {
                        console.error('Error checking admin status:', error);
                        this.isAdmin = false;
                        // Cacher le bouton en cas d'erreur
                        const bellContainer = document.querySelector('#onesignal-bell-container');
                        if (bellContainer) {
                            bellContainer.classList.remove('show-bell');
                        }
                    }
                },
                async loadAllData() {
                    if (!this.isAdmin) return;
                    try {
                        // Charger tous les utilisateurs d'abord
                        const usersSnapshot = await db.collection('users').get();
                        this.userEmails = {};
                        usersSnapshot.docs.forEach(doc => {
                            this.userEmails[doc.id] = {
                                email: doc.data().email,
                                firstName: doc.data().firstName || '',
                                lastName: doc.data().lastName || '',
                                address: doc.data().address || '',
                                role: doc.data().role
                            };
                        });

                        // Mettre en place l'écoute en temps réel pour les animaux
                        if (this.unsubscribeAdminAnimals) {
                            this.unsubscribeAdminAnimals();
                        }

                        this.unsubscribeAdminAnimals = db.collection('animals')
                            .orderBy('createdAt', 'desc')
                            .onSnapshot(snapshot => {
                                this.allAnimals = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                                console.log('Liste des animaux mise à jour en temps réel');
                            }, error => {
                                console.error('Erreur dans l\'écoute des animaux:', error);
                            });

                        // Charger tous les rendez-vous
                        const appointmentsSnapshot = await db.collection('appointments').get();
                        this.allAppointments = appointmentsSnapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));

                        // Charger tous les clients (users)
                        this.allClients = usersSnapshot.docs
                            .filter(doc => doc.data().role !== 'admin')
                            .map(doc => ({
                                id: doc.id,
                                firstName: doc.data().firstName || '',
                                lastName: doc.data().lastName || '',
                                email: doc.data().email,
                                address: doc.data().address || '',
                                createdAt: doc.data().createdAt || firebase.firestore.FieldValue.serverTimestamp(),
                                animalsCount: this.allAnimals.filter(animal => animal.userId === doc.id).length
                            }));

                        await this.loadMessages();
                    } catch (error) {
                        console.error('Error loading admin data:', error);
                    }
                },
                getUserFullName(userId) {
                    const user = this.userEmails[userId];
                    if (!user) return 'Client non trouvé';
                    return `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email || 'Client non trouvé';
                },
                async editAnimal(animal) {
                    this.editingAnimal = { ...animal };
                    this.showEditAnimalModal = true;
                },
                async updateAnimal() {
                    try {
                        await db.collection('animals').doc(this.editingAnimal.id).update({
                            name: this.editingAnimal.name,
                            species: this.editingAnimal.species,
                            race: this.editingAnimal.race,
                            birthdate: this.editingAnimal.birthdate,
                            sterilization: this.editingAnimal.sterilization,
                            sterilizationDetails: this.editingAnimal.sterilizationDetails,
                            diet: this.editingAnimal.diet,
                            activity: this.editingAnimal.activity,
                            activityDetails: this.editingAnimal.activityDetails,
                            medicalHistory: this.editingAnimal.medicalHistory,
                            treatment: this.editingAnimal.treatment,
                            behavior: this.editingAnimal.behavior,
                            notes: this.editingAnimal.notes,
                            userId: this.editingAnimal.userId,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        // Mettre à jour la liste locale
                        const index = this.allAnimals.findIndex(a => a.id === this.editingAnimal.id);
                        if (index !== -1) {
                            this.allAnimals[index] = { ...this.editingAnimal };
                        }

                        this.showEditAnimalModal = false;
                        this.editingAnimal = null;
                        alert('Animal modifié avec succès');
                    } catch (error) {
                        console.error('Error updating animal:', error);
                        alert('Erreur lors de la modification: ' + error.message);
                    }
                },
                async editAppointment(appointment) {
                    this.editingAppointment = { ...appointment };
                    await this.loadUnavailableSlots();
                    this.showEditAppointmentModal = true;
                },
                async updateAppointment() {
                    try {
                        // Vérifier si le créneau est toujours disponible
                        if (this.isTimeSlotUnavailable(this.editingAppointment.time) && 
                            this.editingAppointment.time !== this.editingAppointment.originalTime) {
                            alert('Ce créneau n\'est plus disponible');
                            return;
                        }

                        await db.collection('appointments').doc(this.editingAppointment.id).update({
                            date: this.editingAppointment.date,
                            time: this.editingAppointment.time,
                            phone: this.editingAppointment.phone,
                            notes: this.editingAppointment.notes,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        // Mettre à jour la liste locale
                        const index = this.allAppointments.findIndex(a => a.id === this.editingAppointment.id);
                        if (index !== -1) {
                            this.allAppointments[index] = { ...this.editingAppointment };
                        }

                        this.showEditAppointmentModal = false;
                        this.editingAppointment = null;
                        alert('Rendez-vous modifié avec succès');
                    } catch (error) {
                        console.error('Error updating appointment:', error);
                        alert('Erreur lors de la modification: ' + error.message);
                    }
                },
                async deleteAnimal(animal) {
                    if (!confirm(`Êtes-vous sûr de vouloir supprimer ${animal.name} ?`)) return;
                    try {
                        await db.collection('animals').doc(animal.id).delete();
                        this.allAnimals = this.allAnimals.filter(a => a.id !== animal.id);
                        alert('Animal supprimé avec succès');
                    } catch (error) {
                        console.error('Error deleting animal:', error);
                        alert('Erreur lors de la suppression');
                    }
                },
                async deleteAppointment(appointment) {
                    if (!confirm(`Êtes-vous sûr de vouloir supprimer ce rendez-vous ?`)) return;
                    try {
                        // Trouver le créneau correspondant
                        const appointmentDate = new Date(appointment.date);
                        const startOfDay = new Date(appointmentDate);
                        startOfDay.setHours(0, 0, 0, 0);
                        const endOfDay = new Date(appointmentDate);
                        endOfDay.setHours(23, 59, 59, 999);

                        console.log('DEBUG - Searching for slot to update:', {
                            date: appointment.date,
                            time: appointment.time
                        });

                        // Rechercher le créneau correspondant
                        const timeSlotSnapshot = await db.collection('timeSlots')
                            .where('date', '>=', firebase.firestore.Timestamp.fromDate(startOfDay))
                            .where('date', '<=', firebase.firestore.Timestamp.fromDate(endOfDay))
                            .where('time', '==', appointment.time)
                            .get();

                        // Supprimer le rendez-vous de l'historique de l'animal s'il existe
                        if (appointment.animalId) {
                            const animalRef = db.collection('animals').doc(appointment.animalId);
                            const animalDoc = await animalRef.get();
                            
                            if (animalDoc.exists) {
                                const animalData = animalDoc.data();
                                const updatedAppointments = animalData.appointments.filter(apt => apt.id !== appointment.id);
                                
                                await animalRef.update({
                                    appointments: updatedAppointments
                                });
                            }
                        }

                        // Supprimer le rendez-vous
                        await db.collection('appointments').doc(appointment.id).delete();

                        // Mettre à jour le créneau si trouvé
                        if (!timeSlotSnapshot.empty) {
                            console.log('DEBUG - Found slot to update:', timeSlotSnapshot.docs[0].id);
                            await db.collection('timeSlots')
                                .doc(timeSlotSnapshot.docs[0].id)
                                .update({
                                    unavailable: false,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                        }

                        // Mettre à jour la liste locale
                        this.allAppointments = this.allAppointments.filter(a => a.id !== appointment.id);
                        alert('Rendez-vous supprimé avec succès');

                        // Recharger les créneaux si on est sur la page admin des créneaux
                        if (this.adminActiveTab === 'slots') {
                            await this.loadSlots();
                        }
                    } catch (error) {
                        console.error('Error deleting appointment:', error);
                        alert('Erreur lors de la suppression: ' + error.message);
                    }
                },
                previousMonth() {
                    if (this.currentMonth === 0) {
                        this.currentMonth = 11;
                        this.currentYear--;
                    } else {
                        this.currentMonth--;
                    }
                },
                nextMonth() {
                    if (this.currentMonth === 11) {
                        this.currentMonth = 0;
                        this.currentYear++;
                    } else {
                        this.currentMonth++;
                    }
                },
                isToday(date) {
                    const today = new Date();
                    return date.getDate() === today.getDate() &&
                           date.getMonth() === today.getMonth() &&
                           date.getFullYear() === today.getFullYear();
                },
                isCurrentMonth(date) {
                    return date.getMonth() === this.currentMonth &&
                           date.getFullYear() === this.currentYear;
                },
                hasSlots(date) {
                    return this.slots.some(slot => 
                        slot.date.toDateString() === date.toDateString()
                    );
                },
                getSlotsCount(date) {
                    return this.slots.filter(slot => 
                        slot.date.toDateString() === date.toDateString()
                    ).length;
                },
                selectDate(date) {
                    if (this.isCurrentMonth(date)) {
                        this.selectedDate = date;
                    }
                },
                getDateSlots(date) {
                    return this.slots.filter(slot => 
                        slot.date.toDateString() === date.toDateString()
                    );
                },
                async addSlots() {
                    try {
                        const slotsToAdd = [];
                        const startDate = new Date(this.newSlot.date);
                        const endDate = this.newSlot.recurrence !== 'none' ? new Date(this.newSlot.endDate) : startDate;

                        // Validation de base
                        if (!this.newSlot.time || !this.newSlot.date) {
                            throw new Error('La date et l\'heure sont requises');
                        }

                        // Générer tous les créneaux à ajouter
                        if (this.newSlot.recurrence === 'none') {
                            const slotDate = new Date(startDate);
                            const [hours, minutes] = this.newSlot.time.split(':');
                            slotDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                            
                            slotsToAdd.push({
                                date: firebase.firestore.Timestamp.fromDate(slotDate),
                                time: this.newSlot.time,
                                duration: parseInt(this.newSlot.duration),
                                unavailable: false
                            });
                        } else {
                            let currentDate = new Date(startDate);
                            while (currentDate <= endDate) {
                                const slotDate = new Date(currentDate);
                                const [hours, minutes] = this.newSlot.time.split(':');
                                slotDate.setHours(parseInt(hours), parseInt(minutes), 0, 0);
                                
                                slotsToAdd.push({
                                    date: firebase.firestore.Timestamp.fromDate(slotDate),
                                    time: this.newSlot.time,
                                    duration: parseInt(this.newSlot.duration),
                                    unavailable: false
                                });
                                
                                // Passer à la date suivante selon la récurrence
                                switch(this.newSlot.recurrence) {
                                    case 'daily':
                                        currentDate.setDate(currentDate.getDate() + 1);
                                        break;
                                    case 'weekly':
                                        currentDate.setDate(currentDate.getDate() + 7);
                                        break;
                                    case 'monthly':
                                        currentDate.setMonth(currentDate.getMonth() + 1);
                                        break;
                                }
                            }
                        }

                        // Vérifier les doublons pour tous les créneaux d'un coup
                        const conflictingSlots = [];
                        for (const slot of slotsToAdd) {
                            const dateStr = slot.date.toDate().toISOString().split('T')[0];
                            const existingSlots = await db.collection('timeSlots')
                                .where('date', '>=', slot.date)
                                .where('date', '<=', slot.date)
                                .get();

                            const hasConflict = existingSlots.docs.some(doc => doc.data().time === slot.time);
                            if (hasConflict) {
                                const formattedDate = slot.date.toDate().toLocaleDateString('fr-FR', {
                                    weekday: 'long',
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric'
                                });
                                conflictingSlots.push(`${formattedDate} à ${slot.time}`);
                            }
                        }

                        // S'il y a des conflits, afficher tous les créneaux en conflit
                        if (conflictingSlots.length > 0) {
                            throw new Error(
                                'Des créneaux existent déjà aux dates suivantes :\n' +
                                conflictingSlots.join('\n')
                            );
                        }
                        
                        // Si aucun conflit, ajouter tous les créneaux
                        const batch = db.batch();
                        for (const slot of slotsToAdd) {
                            const newSlotRef = db.collection('timeSlots').doc();
                            batch.set(newSlotRef, {
                                ...slot,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                        await batch.commit();
                        
                        this.showAddSlotModal = false;
                        this.newSlot = {
                            time: '',
                            date: '',
                            duration: '60',
                            recurrence: 'none',
                            endDate: ''
                        };
                        await this.loadSlots();
                        
                        // Message de succès avec le nombre de créneaux ajoutés
                        const message = slotsToAdd.length === 1
                            ? 'Créneau ajouté avec succès'
                            : `${slotsToAdd.length} créneaux ajoutés avec succès`;
                        alert(message);
                    } catch (error) {
                        console.error('Error adding slots:', error);
                        alert(error.message || 'Erreur lors de l\'ajout des créneaux');
                    }
                },
                async toggleSlotAvailability(slot) {
                    try {
                        await db.collection('timeSlots').doc(slot.id).update({
                            unavailable: !slot.unavailable,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        await this.loadSlots();
                    } catch (error) {
                        console.error('Error toggling slot availability:', error);
                        alert('Erreur lors de la modification du créneau: ' + error.message);
                    }
                },
                async deleteSlot(slot) {
                    if (!confirm('Êtes-vous sûr de vouloir supprimer ce créneau ?')) return;
                    try {
                        await db.collection('timeSlots').doc(slot.id).delete();
                        await this.loadSlots();
                        alert('Créneau supprimé avec succès');
                    } catch (error) {
                        console.error('Error deleting slot:', error);
                        alert('Erreur lors de la suppression du créneau: ' + error.message);
                    }
                },
                async loadSlots() {
                    try {
                        console.log('Loading admin slots...');
                        
                        // Nettoyer l'ancien écouteur
                        if (this.unsubscribeAdminSlots) {
                            this.unsubscribeAdminSlots();
                            this.unsubscribeAdminSlots = null;
                        }

                        // Vérifier que l'utilisateur est admin
                        if (!this.isAdmin) {
                            console.log('User is not admin, skipping slots load');
                            return;
                        }

                        this.unsubscribeAdminSlots = db.collection('timeSlots')
                            .orderBy('date')
                            .onSnapshot(snapshot => {
                                console.log('Admin slots snapshot:', snapshot.docs.length, 'slots found');
                                
                                this.slots = snapshot.docs.map(doc => ({
                                    id: doc.id,
                                    ...doc.data(),
                                    date: doc.data().date.toDate()
                                }));
                                
                                console.log('Processed slots:', this.slots.length);
                                console.log('Slots data:', this.slots);
                            }, error => {
                                console.error('Error in admin slots listener:', error);
                                this.slots = [];
                            });
                    } catch (error) {
                        console.error('Error loading slots:', error);
                        this.slots = [];
                    }
                },
                async syncTimeSlots() {
                    if (!this.isAuthenticated) {
                        console.log('Synchronisation des créneaux ignorée : utilisateur non connecté');
                        return;
                    }

                    try {
                        console.log('Début de la synchronisation des créneaux...');
                        
                        // Récupérer tous les rendez-vous
                        const appointmentsSnapshot = await db.collection('appointments')
                            .where('date', '>=', firebase.firestore.Timestamp.fromDate(new Date()))
                            .get();
                        
                        // Traiter les rendez-vous par lots de 10 pour éviter les limitations
                        const appointments = appointmentsSnapshot.docs;
                        for (let i = 0; i < appointments.length; i += 10) {
                            const batch = appointments.slice(i, i + 10);
                            await Promise.all(batch.map(async (appointmentDoc) => {
                                const appointment = appointmentDoc.data();
                                const appointmentDate = new Date(appointment.date);
                                const startOfDay = new Date(appointmentDate);
                                startOfDay.setHours(0, 0, 0, 0);
                                const endOfDay = new Date(appointmentDate);
                                endOfDay.setHours(23, 59, 59, 999);

                                try {
                                    // Trouver le créneau correspondant
                                    const timeSlotSnapshot = await db.collection('timeSlots')
                                        .where('date', '>=', firebase.firestore.Timestamp.fromDate(startOfDay))
                                        .where('date', '<=', firebase.firestore.Timestamp.fromDate(endOfDay))
                                        .where('time', '==', appointment.time)
                                        .get();

                                    if (!timeSlotSnapshot.empty) {
                                        // Mettre à jour le créneau
                                        await db.collection('timeSlots')
                                            .doc(timeSlotSnapshot.docs[0].id)
                                            .update({
                                                unavailable: true,
                                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                            });
                                    }
                                } catch (error) {
                                    console.warn(`Erreur lors de la mise à jour du créneau pour le rendez-vous ${appointmentDoc.id}:`, error);
                                }
                            }));
                        }
                        
                        console.log('Synchronisation des créneaux terminée avec succès');
                    } catch (error) {
                        if (error.code === 'permission-denied') {
                            console.warn('Synchronisation des créneaux ignorée : permissions insuffisantes');
                        } else {
                            console.error('Erreur lors de la synchronisation des créneaux:', error);
                        }
                    }
                },
                async loadAvailableDates() {
                    try {
                        console.log('Loading available dates...');
                        this.isLoadingDates = true;
                        
                        // Calculer la date de début (demain)
                        const tomorrow = new Date();
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        tomorrow.setHours(0, 0, 0, 0);
                        
                        const thirtyDaysFromNow = new Date();
                        thirtyDaysFromNow.setDate(tomorrow.getDate() + 30);
                        thirtyDaysFromNow.setHours(23, 59, 59, 999);

                        console.log('Date range:', tomorrow.toISOString(), 'to', thirtyDaysFromNow.toISOString());

                        // Nettoyer l'ancien écouteur
                        if (this.unsubscribeAvailableDates) {
                            this.unsubscribeAvailableDates();
                        }

                        this.unsubscribeAvailableDates = db.collection('timeSlots')
                            .where('date', '>=', firebase.firestore.Timestamp.fromDate(tomorrow))
                            .where('date', '<=', firebase.firestore.Timestamp.fromDate(thirtyDaysFromNow))
                            .where('unavailable', '==', false)
                            .onSnapshot(snapshot => {
                                console.log('Available dates snapshot:', snapshot.docs.length, 'slots found');
                                
                                // Extraire les dates uniques des créneaux disponibles
                                const availableDatesSet = new Set();
                                snapshot.forEach(doc => {
                                    const slotDate = doc.data().date.toDate();
                                    const dateString = slotDate.toISOString().split('T')[0];
                                    availableDatesSet.add(dateString);
                                });

                                this.availableDates = Array.from(availableDatesSet).sort();
                                console.log('Available dates:', this.availableDates);
                                this.isLoadingDates = false;
                            }, error => {
                                console.error('Error loading available dates:', error);
                                this.isLoadingDates = false;
                                this.availableDates = [];
                            });

                    } catch (error) {
                        console.error('Error setting up available dates listener:', error);
                        this.isLoadingDates = false;
                        this.availableDates = [];
                    }
                },
                async handlePhotosUpload(event) {
                    const files = Array.from(event.target.files);
                    if (files.length === 0) return;

                    // Vérifier le nombre maximum d'images
                    if (files.length > 10) {
                        alert('Vous ne pouvez pas sélectionner plus de 10 images à la fois.');
                        event.target.value = '';
                        return;
                    }

                    // Initialiser les tableaux si nécessaire
                    if (!this.newAnimal.photosPreview) this.newAnimal.photosPreview = [];
                    if (!this.newAnimal.photosBase64) this.newAnimal.photosBase64 = [];

                    for (const file of files) {
                        // Vérifier le type de fichier
                        if (!file.type.startsWith('image/')) {
                            alert(`Le fichier ${file.name} doit être une image`);
                            continue;
                        }

                        try {
                            // Créer un aperçu de l'image
                            const reader = new FileReader();
                            reader.onload = async (e) => {
                                // Créer une image pour le redimensionnement
                                const img = new Image();
                                img.onload = async () => {
                                    // Créer un canvas pour le redimensionnement
                                    const canvas = document.createElement('canvas');
                                    let width = img.width;
                                    let height = img.height;
                                    
                                    // Calculer les nouvelles dimensions en gardant le ratio
                                    const MAX_WIDTH = 800;
                                    const MAX_HEIGHT = 800;
                                    
                                    if (width > height) {
                                        if (width > MAX_WIDTH) {
                                            height *= MAX_WIDTH / width;
                                            width = MAX_WIDTH;
                                        }
                                    } else {
                                        if (height > MAX_HEIGHT) {
                                            width *= MAX_HEIGHT / height;
                                            height = MAX_HEIGHT;
                                        }
                                    }
                                    
                                    canvas.width = width;
                                    canvas.height = height;
                                    
                                    // Dessiner l'image redimensionnée
                                    const ctx = canvas.getContext('2d');
                                    ctx.drawImage(img, 0, 0, width, height);
                                    
                                    // Convertir en base64 avec compression
                                    const resizedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                                    
                                    // Vérifier la taille finale
                                    const base64Size = resizedBase64.length * 3 / 4;
                                    if (base64Size > 900000) { // ~900KB pour avoir une marge
                                        alert(`L'image ${file.name} est trop grande même après compression. Veuillez choisir une image plus petite.`);
                                        return;
                                    }
                                    
                                    // Ajouter à la liste des photos
                                    this.newAnimal.photosPreview.push(resizedBase64);
                                    this.newAnimal.photosBase64.push(resizedBase64);
                                };
                                img.src = e.target.result;
                            };
                            reader.readAsDataURL(file);
                        } catch (error) {
                            console.error('Erreur lors du traitement de l\'image:', error);
                            alert(`Erreur lors du traitement de l'image ${file.name}. Veuillez réessayer avec une autre image.`);
                        }
                    }
                },
                removePhoto(index) {
                    if (this.newAnimal.photosPreview && this.newAnimal.photosBase64) {
                        this.newAnimal.photosPreview.splice(index, 1);
                        this.newAnimal.photosBase64.splice(index, 1);
                    }
                },
                async handleDocumentUpload(event) {
                    const file = event.target.files[0];
                    if (file) {
                        try {
                            console.log('Début du traitement du document:', file.name);

                        if (!file.type.startsWith('image/')) {
                            alert('Le fichier doit être une image');
                            event.target.value = '';
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = (e) => {
                                const img = new Image();
                                img.onload = async () => {
                                    console.log('Image chargée, début du redimensionnement');
                                    const canvas = document.createElement('canvas');
                                    let width = img.width;
                                    let height = img.height;
                                    
                                    // Redimensionnement si nécessaire
                                    const MAX_WIDTH = 1400;
                                    const MAX_HEIGHT = 1400;
                                    
                                    if (width > MAX_WIDTH) {
                                        height *= MAX_WIDTH / width;
                                        width = MAX_WIDTH;
                                    }
                                    
                                    if (height > MAX_HEIGHT) {
                                        width *= MAX_HEIGHT / height;
                                        height = MAX_HEIGHT;
                                    }
                                    
                                    canvas.width = width;
                                    canvas.height = height;
                                    
                                    const ctx = canvas.getContext('2d');
                                    ctx.drawImage(img, 0, 0, width, height);
                                    
                                    const resizedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                                    console.log('Image redimensionnée, taille:', resizedBase64.length);
                                    
                                    const newDocument = {
                                        id: Date.now().toString(),
                                        name: file.name,
                                        date: new Date().toISOString(),
                                        data: resizedBase64
                                    };
                                    
                                    console.log('Document créé avec ID:', newDocument.id);
                                    
                                    if (!this.newAnimal.documents) {
                                        this.newAnimal.documents = [];
                                        console.log('Initialisation du tableau documents');
                                    }
                                    
                                    this.newAnimal.documents.push(newDocument);
                                    console.log('Document ajouté, nombre total:', this.newAnimal.documents.length);
                                    console.log('Documents actuels:', JSON.stringify(this.newAnimal.documents));
                                    
                                    this.$forceUpdate();
                                };
                                img.src = e.target.result;
                        };
                        reader.readAsDataURL(file);
                        } catch (error) {
                            console.error('Erreur détaillée lors du traitement du document:', error);
                            alert('Erreur lors du traitement du document. Veuillez réessayer.');
                            event.target.value = '';
                        }
                    }
                },
                // Ajout d'une méthode pour gérer les annotations sur le plan du corps
                addBodyAnnotation(animalId) {
                    // Trouver le SVG du body map
                    const svgContainer = document.querySelector(`#bodyMap-${animalId}`);
                    if (!svgContainer) return;
                    const svg = svgContainer.querySelector('img');
                    if (!svg) return;

                    // Ajouter un overlay pour capter le clic
                    let overlay = svgContainer.querySelector('.annotation-overlay');
                    if (!overlay) {
                        overlay = document.createElement('div');
                        overlay.className = 'annotation-overlay';
                        overlay.style.position = 'absolute';
                        overlay.style.top = 0;
                        overlay.style.left = 0;
                        overlay.style.width = '100%';
                        overlay.style.height = '100%';
                        overlay.style.cursor = 'crosshair';
                        overlay.style.zIndex = 10;
                        svgContainer.style.position = 'relative';
                        svgContainer.appendChild(overlay);
                    }

                    overlay.onclick = (e) => {
                        // Calculer la position relative au SVG
                        const rect = svg.getBoundingClientRect();
                        const x = ((e.clientX - rect.left) / rect.width);
                        const y = ((e.clientY - rect.top) / rect.height);

                        // Créer un mini-formulaire à la position du clic
                        const form = document.createElement('form');
                        form.className = 'annotation-form';
                        form.style.position = 'absolute';
                        form.style.left = `${x * 100}%`;
                        form.style.top = `${y * 100}%`;
                        form.style.transform = 'translate(-50%, -50%)';
                        form.innerHTML = `
                            <input type="text" placeholder="Texte de l'annotation" required style="padding:0.3rem 0.7rem; border-radius:6px; border:1px solid #ccc; font-size:1rem;">
                            <button type="submit" style="margin-left:0.5rem; background:var(--primary-color); color:white; border:none; border-radius:6px; padding:0.3rem 0.8rem; font-weight:600;">OK</button>
                        `;
                        overlay.appendChild(form);
                        form.querySelector('input').focus();

                        form.onsubmit = async (ev) => {
                            ev.preventDefault();
                            const text = form.querySelector('input').value;
                            // Charger les annotations existantes
                            const animalRef = firebase.firestore().collection('animals').doc(animalId);
                            const animalDoc = await animalRef.get();
                            let annotations = animalDoc.data().annotations || [];
                            annotations.push({ x, y, text });
                            await animalRef.update({ annotations });
                            form.remove();
                            overlay.remove();
                            // Rafraîchir l'affichage des annotations
                            this.displayBodyAnnotations(animalId);
                        };

                        // Un seul formulaire à la fois
                        overlay.onclick = null;
                    };
                },

                displayBodyAnnotations(animalId) {
                    const svgContainer = document.querySelector(`#bodyMap-${animalId}`);
                    if (!svgContainer) return;
                    svgContainer.style.position = 'relative';
                    const img = svgContainer.querySelector('img');
                    if (!img) return;
                    if (!img.complete) {
                        img.onload = () => {
                            setTimeout(() => {
                                this.displayBodyAnnotations(animalId);
                            }, 50);
                        };
                        return;
                    }
                    svgContainer.querySelectorAll('.annotation-point').forEach(el => el.remove());
                    firebase.firestore().collection('animals').doc(animalId).get().then(doc => {
                        const annotations = doc.data().annotations || [];
                        const points = [];
                        const lines = [];
                        annotations.forEach((ann, idx) => {
                            const point = document.createElement('div');
                            point.className = 'annotation-point';
                            point.style.position = 'absolute';
                            point.style.left = `${ann.x * 100}%`;
                            point.style.top = `${ann.y * 100}%`;
                            point.style.transform = 'translate(-50%, -50%)';
                            point.style.width = '18px';
                            point.style.height = '18px';
                            point.style.background = 'var(--accent-color)';
                            point.style.border = '2px solid white';
                            point.style.borderRadius = '50%';
                            point.style.zIndex = 20;
                            point.style.cursor = 'pointer';
                            point.title = ann.text;
                            point.onmouseenter = null;
                            point.onmouseleave = null;
                            svgContainer.appendChild(point);
                            points.push(point);
                        });
                        // Remplir la liste sous le SVG
                        const listContainer = document.getElementById(`annotations-list-${animalId}`);
                        if (listContainer) {
                            const ul = listContainer.querySelector('ul');
                            ul.innerHTML = '';
                            if (annotations.length === 0) {
                                const li = document.createElement('li');
                                li.textContent = 'Aucune annotation';
                                ul.appendChild(li);
                            } else {
                                annotations.forEach((ann, idx) => {
                                    const li = document.createElement('li');
                                    const dot = document.createElement('span');
                                    dot.className = 'annotation-dot';
                                    li.appendChild(dot);
                                    li.appendChild(document.createTextNode(ann.text));
                                    // Bouton suppression
                                    const delBtn = document.createElement('button');
                                    delBtn.className = 'annotation-delete-btn';
                                    delBtn.title = 'Supprimer cette annotation';
                                    delBtn.innerHTML = '&times;';
                                    delBtn.onclick = async (e) => {
                                        e.stopPropagation();
                                        annotations.splice(idx, 1);
                                        await firebase.firestore().collection('animals').doc(animalId).update({ annotations });
                                        this.displayBodyAnnotations(animalId);
                                    };
                                    li.appendChild(delBtn);
                                    ul.appendChild(li);
                                    lines.push(li);
                                });
                            }
                        }
                        // Synchronisation du survol
                        points.forEach((point, idx) => {
                            point.addEventListener('mouseenter', () => {
                                lines[idx]?.classList.add('active');
                            });
                            point.addEventListener('mouseleave', () => {
                                lines[idx]?.classList.remove('active');
                            });
                        });
                        lines.forEach((li, idx) => {
                            li.addEventListener('mouseenter', () => {
                                points[idx]?.classList.add('active');
                            });
                            li.addEventListener('mouseleave', () => {
                                points[idx]?.classList.remove('active');
                            });
                        });
                    });
                },
                async editClient(client) {
                    this.editingClient = { 
                        ...client,
                        address: client.address || '' // S'assurer que l'adresse est définie
                    };
                    this.showEditClientModal = true;
                },
                async updateClient() {
                    try {
                        await db.collection('users').doc(this.editingClient.id).update({
                            firstName: this.editingClient.firstName,
                            lastName: this.editingClient.lastName,
                            email: this.editingClient.email,
                            address: this.editingClient.address,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        this.showEditClientModal = false;
                        alert('Client modifié avec succès');
                    } catch (error) {
                        console.error('Error updating client:', error);
                        alert('Erreur lors de la modification: ' + error.message);
                    }
                },
                async deleteClient(client) {
                    if (!confirm(`Êtes-vous sûr de vouloir supprimer le client ${client.firstName} ${client.lastName} ? Cette action supprimera également tous ses animaux et rendez-vous.`)) return;
                    try {
                        // Commencer une transaction batch
                        const batch = db.batch();

                        // 1. Supprimer tous les animaux du client
                        const animalsSnapshot = await db.collection('animals')
                            .where('userId', '==', client.id)
                            .get();
                        animalsSnapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });

                        // 2. Supprimer tous les rendez-vous du client
                        const appointmentsSnapshot = await db.collection('appointments')
                            .where('userId', '==', client.id)
                            .get();
                        appointmentsSnapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });

                        // 3. Supprimer tous les messages du client
                        const messagesSnapshot = await db.collection('contact_messages')
                            .where('userId', '==', client.id)
                            .get();
                        messagesSnapshot.docs.forEach(doc => {
                            batch.delete(doc.ref);
                        });

                        // 4. Supprimer le document utilisateur
                        batch.delete(db.collection('users').doc(client.id));

                        // Exécuter toutes les opérations de suppression
                        await batch.commit();

                        // Mettre à jour la liste locale des clients
                        this.allClients = this.allClients.filter(c => c.id !== client.id);
                        alert('Client et toutes ses données associées supprimés avec succès');

                        // Recharger les données pour mettre à jour les autres listes
                        this.loadAllData();
                    } catch (error) {
                        console.error('Error deleting client:', error);
                        alert('Erreur lors de la suppression: ' + error.message);
                    }
                },
                viewClientAnimals(client) {
                    this.selectedClient = client;
                    this.clientAnimals = this.allAnimals.filter(animal => animal.userId === client.id);
                    this.showClientAnimalsModal = true;
                },
                async loadMessages() {
                    if (!this.isAdmin) return;
                    
                    if (this.unsubscribeMessages) {
                        this.unsubscribeMessages();
                    }

                    this.unsubscribeMessages = db.collection('contact_messages')
                        .orderBy('createdAt', 'desc')
                        .onSnapshot(snapshot => {
                            this.messages = snapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                            this.unreadMessagesCount = this.messages.filter(m => m.status === 'unread').length;
                        });
                },
                async toggleMessageStatus(message) {
                    try {
                        await db.collection('contact_messages').doc(message.id).update({
                            status: message.status === 'unread' ? 'read' : 'unread'
                        });
                    } catch (error) {
                        console.error('Error updating message status:', error);
                        alert('Erreur lors de la mise à jour du statut du message');
                    }
                },
                async deleteMessage(message) {
                    if (!confirm('Êtes-vous sûr de vouloir supprimer ce message ?')) return;
                    try {
                        await db.collection('contact_messages').doc(message.id).delete();
                    } catch (error) {
                        console.error('Error deleting message:', error);
                        alert('Erreur lors de la suppression du message');
                    }
                },
                // Méthodes pour le tutoriel
                startTutorial() {
                    this.currentTutorialStepIndex = 0;
                    this.showTutorial = true;
                    // Ouvrir le menu burger sur mobile
                    if (window.innerWidth <= 768) {
                        this.isMenuOpen = true;
                    }
                    this.highlightCurrentElement();
                },
                skipTutorial() {
                    this.showTutorial = false;
                    this.removeHighlights();
                    // Fermer le menu burger si on était sur mobile
                    if (window.innerWidth <= 768) {
                        this.isMenuOpen = false;
                    }
                },
                nextTutorialStep() {
                    this.removeHighlights();
                    if (this.currentTutorialStepIndex < this.tutorialSteps.length - 1) {
                        this.currentTutorialStepIndex++;
                        // Ouvrir le menu burger sur mobile pour les étapes concernées
                        if (window.innerWidth <= 768) {
                            if ([1, 2, 4].includes(this.currentTutorialStepIndex)) {
                                this.isMenuOpen = true;
                            }
                        }
                        this.highlightCurrentElement();
                    }
                },
                highlightCurrentElement() {
                    this.removeHighlights();
                    let elementToHighlight;
                    const isMobile = window.innerWidth <= 768;
                    let retryCount = 0;
                    const tryHighlight = () => {
                        switch(this.currentTutorialStepIndex) {
                            case 0: // Bienvenue
                                // Pas de highlight
                                break;
                            case 1: // Connexion
                                elementToHighlight = document.querySelector('.nav-links a[href="#"]');
                                break;
                            case 2: // Dossier ostéopathique
                                elementToHighlight = document.querySelector('.nav-links a[href="#dossier"]');
                                break;
                            case 3: // Ajouter un animal
                                if (this.currentPage === 'dossier') {
                                    elementToHighlight = document.querySelector('.add-animal, .btn.add-animal');
                                }
                                break;
                            case 4: // Prendre rendez-vous
                                elementToHighlight = document.querySelector('.nav-links a[href="#appointment"]');
                                break;
                        }
                        if (elementToHighlight) {
                            elementToHighlight.classList.add('tutorial-highlight');
                            if (isMobile) {
                                setTimeout(() => {
                                    elementToHighlight.scrollIntoView({
                                        behavior: 'smooth',
                                        block: 'center'
                                    });
                                }, 500);
                            }
                        } else if (retryCount < 3) {
                            retryCount++;
                            setTimeout(tryHighlight, 200);
                        } else {
                            console.warn('Aucun élément à surligner pour l\'étape du tutoriel', this.currentTutorialStepIndex);
                        }
                    };
                    tryHighlight();
                },
                removeHighlights() {
                    document.querySelectorAll('.tutorial-highlight').forEach(el => {
                        el.classList.remove('tutorial-highlight');
                    });
                },
                async loadBlogPosts() {
                    try {
                        if (this.unsubscribeBlogPosts) {
                            this.unsubscribeBlogPosts();
                        }

                        this.unsubscribeBlogPosts = db.collection('blog_posts')
                            .orderBy('date', 'desc')
                            .onSnapshot(snapshot => {
                                // Gérer les modifications en temps réel
                                snapshot.docChanges().forEach(change => {
                                    const post = {
                                        id: change.doc.id,
                                        ...change.doc.data()
                                    };

                                    if (change.type === 'added') {
                                        // Nouveau post
                                        const index = this.blogPosts.findIndex(p => p.id === post.id);
                                        if (index === -1) {
                                            this.blogPosts.push(post);
                                        }
                                    } else if (change.type === 'modified') {
                                        // Post modifié
                                        const index = this.blogPosts.findIndex(p => p.id === post.id);
                                        if (index !== -1) {
                                            this.blogPosts.splice(index, 1, post);
                                        }
                                    } else if (change.type === 'removed') {
                                        // Post supprimé
                                        const index = this.blogPosts.findIndex(p => p.id === post.id);
                                        if (index !== -1) {
                                            this.blogPosts.splice(index, 1);
                                        }
                                    }
                                });

                                // Trier les posts par date
                                this.blogPosts.sort((a, b) => b.date.seconds - a.date.seconds);
                            }, error => {
                                console.error('Error loading blog posts:', error);
                            });
                    } catch (error) {
                        console.error('Error setting up blog posts listener:', error);
                    }
                },
                async addBlogPost() {
                    try {
                        if (!this.newPost.title || !this.newPost.content || !this.newPost.imageUrl) {
                            alert('Veuillez remplir tous les champs obligatoires');
                            return;
                        }

                        const postData = {
                            ...this.newPost,
                            date: firebase.firestore.Timestamp.fromDate(new Date(this.newPost.date)),
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        if (this.editingPost) {
                            // Mise à jour d'un article existant
                            await db.collection('blog_posts').doc(this.editingPost.id).update(postData);
                        } else {
                            // Création d'un nouvel article
                            postData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                            await db.collection('blog_posts').add(postData);
                        }

                        this.showAddPostModal = false;
                        this.editingPost = null;
                        this.newPost = {
                            title: '',
                            content: '',
                            excerpt: '',
                            imageUrl: '',
                            date: new Date().toISOString().split('T')[0]
                        };
                    } catch (error) {
                        console.error('Error saving blog post:', error);
                        alert('Erreur lors de l\'enregistrement de l\'article');
                    }
                },
                showPostDetails(post) {
                    const formattedContent = post.content.replace(/\n/g, '<br>');
                    const modal = document.createElement('div');
                    modal.className = 'modal blog-modal';
                    modal.innerHTML = `
                        <div class="modal-content blog-post-modal">
                            <div class="blog-post-header">
                                <h2>${post.title}</h2>
                                <div class="blog-post-date">${this.formatDate(post.date)}</div>
                            </div>
                            <img src="${post.imageUrl}" alt="${post.title}" class="blog-post-full-image">
                            <div class="blog-post-full-content">${formattedContent}</div>
                            <div class="modal-actions">
                                ${this.isAdmin ? `
                                    <button class="btn primary" onclick="this.closest('.modal').dispatchEvent(new CustomEvent('edit-post'))">Modifier</button>
                                    <button class="btn secondary" onclick="this.closest('.modal').dispatchEvent(new CustomEvent('delete-post'))">Supprimer</button>
                                ` : ''}
                                <button class="btn secondary" id="close-blog-modal">Fermer</button>
                            </div>
                        </div>
                    `;

                    // Ajouter les styles spécifiques pour le modal de blog
                    const style = document.createElement('style');
                    style.textContent = `
                        .blog-post-modal {
                            max-width: 800px;
                            padding: 2rem;
                        }

                        .blog-post-header {
                            margin-bottom: 1.5rem;
                            text-align: center;
                        }

                        .blog-post-header h2 {
                            color: var(--primary-color);
                            font-family: 'Playfair Display', serif;
                            font-size: 2.5rem;
                            margin-bottom: 0.5rem;
                        }

                        .blog-post-full-image {
                            width: 100%;
                            height: 400px;
                            object-fit: cover;
                            border-radius: 15px;
                            margin-bottom: 2rem;
                            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
                        }

                        .blog-post-full-content {
                            font-size: 1.1rem;
                            line-height: 1.8;
                            color: var(--text-color);
                            margin-bottom: 2rem;
                            white-space: pre-line;
                        }

                        @media (max-width: 768px) {
                            .blog-post-modal {
                                padding: 1rem;
                            }

                            .blog-post-header h2 {
                                font-size: 2rem;
                            }

                            .blog-post-full-image {
                                height: 250px;
                            }
                        }
                    `;
                    modal.appendChild(style);

                    // Fonction pour fermer le modal proprement
                    const closeModal = () => {
                        modal.remove();
                        window.removeEventListener('keydown', escListener);
                        window.removeEventListener('popstate', popListener);
                        // Si on a ajouté une entrée à l'historique, on la retire
                        if (window.location.hash === '#blogpost') {
                            history.back();
                        }
                    };

                    // Listener pour la touche Échap
                    const escListener = (e) => {
                        if (e.key === 'Escape') {
                            closeModal();
                        }
                    };
                    window.addEventListener('keydown', escListener);

                    // Listener pour le bouton retour du téléphone
                    const popListener = (e) => {
                        closeModal();
                    };
                    window.addEventListener('popstate', popListener);

                    // Ajoute une entrée à l'historique pour gérer le bouton retour
                    history.pushState({ blogModal: true }, '', '#blogpost');

                    // Bouton fermer
                    modal.querySelector('#close-blog-modal').onclick = closeModal;

                    if (this.isAdmin) {
                        modal.addEventListener('edit-post', () => {
                            this.editPost(post);
                            closeModal();
                        });
                        modal.addEventListener('delete-post', () => {
                            this.deletePost(post);
                            closeModal();
                        });
                    }

                    document.body.appendChild(modal);
                },
                async editPost(post) {
                    this.editingPost = post;
                    this.newPost = {
                        title: post.title,
                        content: post.content,
                        excerpt: post.excerpt,
                        imageUrl: post.imageUrl,
                        date: post.date.toDate().toISOString().split('T')[0]
                    };
                    this.showAddPostModal = true;

                    // Modifier la méthode addBlogPost pour gérer aussi les modifications
                    const modal = document.querySelector('.modal');
                    if (modal) {
                        modal.remove();
                    }
                },
                async deletePost(post) {
                    if (confirm('Êtes-vous sûr de vouloir supprimer cet article ?')) {
                        try {
                            await db.collection('blog_posts').doc(post.id).delete();
                            alert('Article supprimé avec succès');
                        } catch (error) {
                            console.error('Error deleting blog post:', error);
                            alert('Erreur lors de la suppression de l\'article');
                        }
                    }
                },
                viewAnimalDocuments(animal) {
                    if (!animal.documents || animal.documents.length === 0) return;

                    const modal = document.createElement('div');
                    modal.className = 'modal';
                    modal.style.zIndex = '1000';
                    modal.innerHTML = `
                        <div class="modal-content documents-modal">
                            <h2>Documents de ${animal.name}</h2>
                            <div class="documents-grid">
                                ${animal.documents.map(doc => `
                                    <div class="document-card" onclick="this.dispatchEvent(new CustomEvent('view-document', {detail: '${doc.id}', bubbles: true}))">
                                        <img src="${doc.data}" alt="${doc.name}">
                                        <div class="document-info">
                                            <p class="document-name">${doc.name}</p>
                                            <p class="document-date">${this.formatDate(doc.date)}</p>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="modal-actions">
                                <button class="btn secondary" onclick="this.closest('.modal').remove()">Fermer</button>
                            </div>
                        </div>
                    `;

                    // Ajouter les styles spécifiques pour la modal des documents
                    const style = document.createElement('style');
                    style.textContent = `
                        .documents-modal {
                            max-width: 900px;
                            padding: 2rem;
                            z-index: 1000;
                        }

                        .documents-modal h2 {
                            color: var(--primary-color);
                            font-family: 'Playfair Display', serif;
                            text-align: center;
                            margin-bottom: 2rem;
                        }

                        .documents-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fill, minmax(250px, 300px));
                            gap: 1.5rem;
                            margin-bottom: 2rem;
                            justify-content: center;
                        }

                        .document-card {
                            background: white;
                            border-radius: 12px;
                            overflow: hidden;
                            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                            cursor: pointer;
                            transition: transform 0.3s ease;
                        }

                        .document-card:hover {
                            transform: translateY(-5px);
                            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
                        }

                        .document-card img {
                            width: 100%;
                            height: 200px;
                            object-fit: cover;
                        }

                        .document-info {
                            padding: 1rem;
                        }

                        .document-name {
                            color: var(--primary-color);
                            font-weight: 500;
                            margin-bottom: 0.5rem;
                        }

                        .document-date {
                            color: var(--secondary-color);
                            font-size: 0.9rem;
                        }

                        @media (max-width: 768px) {
                            .documents-modal {
                                padding: 1rem;
                                margin: 1rem;
                                width: calc(100% - 2rem);
                            }

                            .documents-grid {
                                grid-template-columns: 1fr;
                                gap: 1rem;
                            }
                        }
                    `;
                    modal.appendChild(style);

                    // Gestion de l'affichage en plein écran des documents
                    modal.addEventListener('view-document', (e) => {
                        const documentId = e.detail;
                        const selectedDoc = animal.documents.find(doc => doc.id === documentId);
                        if (selectedDoc) {
                            const fullscreenModal = window.document.createElement('div');
                            fullscreenModal.className = 'modal';
                            fullscreenModal.style.cssText = 'z-index: 1001; display: flex; align-items: flex-start; justify-content: center; padding: 100px 20px 20px 20px; overflow-y: auto;';
                            fullscreenModal.innerHTML = `
                                <div class="modal-content" style="max-width: 90vw; max-height: calc(100vh - 140px); overflow-y: auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); padding: 1.5rem; position: relative;">
                                    <div style="position: relative;">
                                        <div style="display: flex; justify-content: center; min-height: 200px; max-height: calc(90vh - 100px); overflow-y: auto;">
                                            <img src="${selectedDoc.data}" alt="${selectedDoc.name}" style="width: auto; max-width: 100%; height: auto; object-fit: contain;">
                                        </div>
                                        <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                                            <h3 style="margin: 0; color: var(--primary-color);">${selectedDoc.name}</h3>
                                            <p style="margin: 0.5rem 0 0 0; color: var(--secondary-color);">Ajouté le ${this.formatDate(selectedDoc.date)}</p>
                                        </div>
                                        <button class="btn secondary" style="position: absolute; top: -10px; right: -10px; border-radius: 50%; width: 30px; height: 30px; padding: 0; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2);" onclick="this.closest('.modal').remove()">×</button>
                                    </div>
                                </div>
                            `;
                            window.document.body.appendChild(fullscreenModal);

                            // Fermer avec Échap
                            const handleEscape = (event) => {
                                if (event.key === 'Escape') {
                                    fullscreenModal.remove();
                                    window.removeEventListener('keydown', handleEscape);
                                }
                            };
                            window.addEventListener('keydown', handleEscape);

                            // Fermer en cliquant en dehors
                            fullscreenModal.addEventListener('click', (event) => {
                                if (event.target === fullscreenModal) {
                                    fullscreenModal.remove();
                                    window.removeEventListener('keydown', handleEscape);
                                }
                            });
                        }
                    });

                    document.body.appendChild(modal);

                    // Gestion de la fermeture avec Échap
                    const handleEscape = (e) => {
                        if (e.key === 'Escape') {
                            modal.remove();
                            window.removeEventListener('keydown', handleEscape);
                        }
                    };
                    window.addEventListener('keydown', handleEscape);
                },
                sortAppointments(field) {
                    if (this.sortField === field) {
                        this.sortOrder = this.sortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.sortField = field;
                        this.sortOrder = 'asc';
                    }
                },
                async submitAdminAppointment() {
                    try {
                        if (!this.adminAppointmentForm.userId || !this.adminAppointmentForm.selectedAnimalId || !this.adminAppointmentForm.phone || !this.adminAppointmentForm.date || !this.adminAppointmentForm.time) {
                            alert('Veuillez remplir tous les champs obligatoires');
                            return;
                        }

                        const appointmentData = {
                            userId: this.adminAppointmentForm.userId,
                            selectedAnimalId: this.adminAppointmentForm.selectedAnimalId,
                            phone: this.adminAppointmentForm.phone,
                            date: this.adminAppointmentForm.date,
                            time: this.adminAppointmentForm.time,
                            notes: this.adminAppointmentForm.notes,
                            status: 'pending',
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        };

                        const appointmentRef = await db.collection('appointments').add(appointmentData);

                        // Mettre à jour l'historique de l'animal
                        const animalRef = db.collection('animals').doc(this.adminAppointmentForm.selectedAnimalId);
                        await animalRef.update({
                            appointments: firebase.firestore.FieldValue.arrayUnion({
                                id: appointmentRef.id,
                                date: this.adminAppointmentForm.date,
                                time: this.adminAppointmentForm.time,
                                notes: this.adminAppointmentForm.notes,
                                status: 'pending'
                            })
                        });

                        this.showAdminNewAppointmentModal = false;
                        this.adminAppointmentForm = {
                            userId: '',
                            selectedAnimalId: '',
                            phone: '',
                            date: '',
                            time: '',
                            notes: ''
                        };
                        alert('Rendez-vous ajouté avec succès');
                    } catch (error) {
                        console.error('Error submitting admin appointment:', error);
                        alert('Erreur lors de l\'ajout du rendez-vous');
                    }
                },
                cancelAdminAppointment() {
                    this.showAdminNewAppointmentModal = false;
                    this.adminAppointmentForm = {
                        userId: '',
                        selectedAnimalId: '',
                        phone: '',
                        date: '',
                        time: '',
                        notes: ''
                    };
                },
                loadClientAnimals() {
                    this.clientAnimals = this.allAnimals.filter(animal => animal.userId === this.adminAppointmentForm.userId);
                },
                switchToSlotsTab() {
                    this.adminActiveTab = 'slots';
                    // Forcer le rechargement des créneaux
                    setTimeout(() => {
                        this.loadSlots();
                    }, 100);
                },
                switchAdminTab(tab) {
                    this.adminActiveTab = tab;
                    // Réinitialiser les recherches lors du changement d'onglet
                    this.animalsSearch = '';
                    this.appointmentsSearch = '';
                    this.clientsSearch = '';
                    this.messagesSearch = '';
                },
                // Fonction pour le défilement fluide vers les sections
                smoothScrollTo(targetId) {
                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        // Utiliser scrollIntoView avec des options plus précises
                        targetElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start',
                            inline: 'nearest'
                        });
                        
                        // Fermer le menu mobile si ouvert
                        this.isMenuOpen = false;
                    }
                },
                
                // Fonction pour naviguer vers une section (gère le changement de page si nécessaire)
                navigateToSection(sectionId) {
                    // Si on n'est pas sur la page d'accueil, d'abord y aller
                    if (this.currentPage !== 'home') {
                        this.currentPage = 'home';
                        // Attendre que la page soit chargée avant de faire le scroll
                        this.$nextTick(() => {
                            setTimeout(() => {
                                this.smoothScrollTo(sectionId);
                            }, 100);
                        });
                    } else {
                        // Si on est déjà sur la page d'accueil, faire le scroll directement
                        this.smoothScrollTo(sectionId);
                    }
                },
            },
            mounted() {
                // Gestion de la navigation par hash
                const handleHashChange = () => {
                    const hash = window.location.hash.slice(1);
                    
                    // Si l'utilisateur n'est pas connecté, il ne peut accéder qu'à la page d'accueil et ses sections
                    if (!this.isAuthenticated && (hash === 'appointment' || hash === 'dossier' || hash === 'admin' || hash === 'profile')) {
                        window.location.hash = '';
                        this.currentPage = 'home';
                        return;
                    }

                    // Si l'utilisateur n'est pas admin, il ne peut pas accéder à la page admin
                    if (hash === 'admin' && !this.isAdmin) {
                        window.location.hash = '';
                        this.currentPage = 'home';
                        return;
                    }

                    // Gestion des pages spécifiques
                    switch(hash) {
                        case 'appointment':
                            this.currentPage = 'appointment';
                            if (this.isAuthenticated) {
                                this.loadAnimals();
                                this.syncTimeSlots();
                                this.loadAvailableDates();
                            }
                            break;
                        case 'dossier':
                            this.currentPage = 'dossier';
                            if (this.isAuthenticated) {
                                this.loadAnimals();
                            }
                            break;
                        case 'admin':
                            if (this.isAdmin) {
                                this.currentPage = 'admin';
                                this.loadAllData();
                                setTimeout(() => {
                                    this.loadSlots();
                                }, 100);
                                this.loadAvailableDates();
                            }
                            break;
                        case 'profile':
                            if (this.isAuthenticated) {
                                this.currentPage = 'profile';
                                this.loadProfileData();
                            }
                            break;
                        default:
                            this.currentPage = 'home';
                            const element = document.getElementById(hash);
                            if (element) {
                                element.scrollIntoView({ behavior: 'smooth' });
                            }
                    }
                };

                window.addEventListener('hashchange', handleHashChange);
                handleHashChange();

                // Écouteur d'authentification Firebase
                firebase.auth().onAuthStateChanged(async (user) => {
                    if (user) {
                        this.isAuthenticated = true;
                        this.userEmail = user.email;
                        await this.checkAdminStatus();
                        
                        // Charger les animaux dès la connexion
                        await this.loadAnimals();
                        
                        // Si on est sur la page de rendez-vous, charger les données nécessaires
                        if (this.currentPage === 'appointment') {
                            await this.loadAvailableDates();
                            // Attendre un peu avant de synchroniser
                            setTimeout(() => {
                                this.syncTimeSlots();
                            }, 500);
                        } else if (this.currentPage === 'admin' && this.isAdmin) {
                            await this.loadAllData();
                            setTimeout(() => {
                                this.loadSlots();
                            }, 100);
                            await this.loadAvailableDates();
                        }
                    } else {
                        if (this.unsubscribeAnimals) {
                            this.unsubscribeAnimals();
                        }
                        this.isAuthenticated = false;
                        this.isAdmin = false;
                        this.userEmail = '';
                        this.travelTime = '';
                        this.animals = [];
                        if (window.location.hash === '#appointment' || window.location.hash === '#dossier' || window.location.hash === '#admin' || window.location.hash === '#profile') {
                            window.location.hash = '';
                            this.currentPage = 'home';
                        }
                    }
                });

                // Gestion du responsive
                window.addEventListener('resize', () => {
                    this.isMobile = window.innerWidth <= 768;
                });

                this.loadBlogPosts();
                
                // Si on est déjà sur l'onglet Créneaux, charger les créneaux
                if (this.currentPage === 'admin' && this.adminActiveTab === 'slots' && this.isAdmin) {
                    setTimeout(() => {
                        this.loadSlots();
                    }, 500);
                }
            },
            beforeUnmount() {
                // Nettoyer tous les écouteurs en temps réel
                if (this.unsubscribeAnimals) {
                    this.unsubscribeAnimals();
                }
                if (this.unsubscribeSlots) {
                    this.unsubscribeSlots();
                }
                if (this.unsubscribeAppointments) {
                    this.unsubscribeAppointments();
                }
                if (this.unsubscribeAdminSlots) {
                    this.unsubscribeAdminSlots();
                }
                if (this.unsubscribeAvailableDates) {
                    this.unsubscribeAvailableDates();
                }
                if (this.unsubscribeMessages) {
                    this.unsubscribeMessages();
                }
                if (this.unsubscribeBlogPosts) {
                    this.unsubscribeBlogPosts();
                }
                if (this.unsubscribeAdminAnimals) {
                    this.unsubscribeAdminAnimals();
                }
            }
        }).mount('#app')

        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission().then(function(permission) {
                console.log('Notification permission:', permission);
            });
        }
    </script>
</body>
</html> 